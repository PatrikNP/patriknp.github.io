<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>St√§dQuest üè†‚ú®</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background-color: #f9fafb;
        }

        .container {
            max-width: 672px;
            margin: 0 auto;
            min-height: 100vh;
        }

        .header {
            background: white;
            border-bottom: 2px solid #e5e7eb;
            padding: 1rem;
        }

        .header-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1rem;
        }

        .title {
            font-size: 1.5rem;
            font-weight: bold;
            background: linear-gradient(to right, #2563eb, #06b6d4);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .reset-btn {
            padding: 0.5rem 1rem;
            background: #fee2e2;
            color: #dc2626;
            border: 2px solid #fca5a5;
            border-radius: 0.5rem;
            font-weight: 500;
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .reset-btn:hover {
            background: #fecaca;
            border-color: #f87171;
        }

        select {
            padding: 0.5rem 1rem;
            border: 2px solid #e5e7eb;
            border-radius: 0.5rem;
            font-weight: 500;
            font-size: 1rem;
        }

        .content {
            padding: 1rem;
            padding-bottom: 6rem;
        }

        .gradient-box {
            background: linear-gradient(to right, #3b82f6, #06b6d4);
            border-radius: 1rem;
            padding: 1.5rem;
            color: white;
            margin-bottom: 1.5rem;
        }

        .gradient-box-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .stat-box {
            padding: 1rem;
            border-radius: 0.75rem;
            text-align: center;
        }

        .stat-box.blue { background: #dbeafe; }
        .stat-box.orange { background: #fed7aa; }
        .stat-box.teal { background: #ccfbf1; }

        .stat-icon { font-size: 1.5rem; margin-bottom: 0.5rem; }
        .stat-value { font-size: 1.5rem; font-weight: bold; }
        .stat-value.blue { color: #2563eb; }
        .stat-value.orange { color: #ea580c; }
        .stat-value.teal { color: #14b8a6; }
        .stat-label { font-size: 0.875rem; color: #4b5563; margin-top: 0.25rem; }

        .section {
            margin-bottom: 1.5rem;
        }

        .section-title {
            font-size: 1.125rem;
            font-weight: bold;
            margin-bottom: 0.75rem;
        }

        .task-card {
            padding: 1rem;
            border-radius: 0.75rem;
            border: 2px solid;
            margin-bottom: 0.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .task-info {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .task-name {
            font-weight: 500;
        }

        .task-room {
            font-size: 0.875rem;
            color: #6b7280;
            margin-top: 0.25rem;
        }

        .badge {
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.875rem;
            font-weight: 500;
            display: inline-block;
        }

        .badge-white {
            background: white;
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
            margin-left: 0.5rem;
        }

        .room-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.75rem;
        }

        .room-button {
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 0.75rem;
            padding: 1rem;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
            overflow: hidden;
        }

        .room-button::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
        }

        .room-button:hover {
            border-color: #3b82f6;
            transform: translateY(-2px);
        }

        .room-icon {
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
        }

        .room-name {
            font-weight: 500;
            margin-bottom: 0.25rem;
        }

        .room-progress {
            font-size: 0.875rem;
            color: #6b7280;
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border-radius: 0.75rem;
            font-weight: 500;
            cursor: pointer;
            border: none;
            transition: all 0.2s;
        }

        .btn-primary {
            background: linear-gradient(to right, #10b981, #059669);
            color: white;
        }

        .btn-primary:hover {
            transform: scale(1.05);
        }

        .btn-secondary {
            background: #14b8a6;
            color: white;
        }

        .btn-secondary:hover {
            background: #0d9488;
        }

        .btn-gray {
            background: #e5e7eb;
            color: #374151;
        }

        .btn-gray:hover {
            background: #d1d5db;
        }

        .btn-disabled {
            background: #f3f4f6;
            color: #9ca3af;
            cursor: not-allowed;
        }

        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            border-top: 2px solid #e5e7eb;
            max-width: 672px;
            margin: 0 auto;
        }

        .nav-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 0.25rem;
            padding: 0.5rem;
        }

        .nav-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.25rem;
            padding: 0.75rem;
            border-radius: 0.75rem;
            background: transparent;
            border: none;
            color: #6b7280;
            cursor: pointer;
            transition: all 0.2s;
        }

        .nav-btn.active {
            background: #dbeafe;
            color: #2563eb;
        }

        .nav-btn svg {
            width: 1.5rem;
            height: 1.5rem;
        }

        .nav-btn span {
            font-size: 0.75rem;
            font-weight: 500;
        }

        .back-btn {
            color: #2563eb;
            font-weight: 500;
            background: none;
            border: none;
            cursor: pointer;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .info-box {
            background: #dbeafe;
            border: 2px solid #93c5fd;
            border-radius: 0.75rem;
            padding: 0.75rem;
            margin-bottom: 1rem;
        }

        .info-text {
            font-size: 0.875rem;
            font-weight: 500;
            color: #1e40af;
        }

        .task-detail {
            padding: 1rem;
            border-radius: 0.75rem;
            border: 2px solid;
            margin-bottom: 0.75rem;
        }

        .task-header {
            display: flex;
            gap: 0.75rem;
            margin-bottom: 0.5rem;
        }

        .task-title {
            font-size: 1.125rem;
            font-weight: 500;
        }

        .task-meta {
            display: flex;
            gap: 1rem;
            font-size: 0.875rem;
            color: #6b7280;
            margin-bottom: 0.5rem;
        }

        .booking-status {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.875rem;
            font-weight: 500;
        }

        .booking-badge {
            padding: 0.25rem 0.5rem;
            border-radius: 9999px;
        }

        .task-actions {
            display: flex;
            gap: 0.5rem;
            margin-left: 1rem;
        }

        .user-card {
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 0.75rem;
            padding: 1rem;
            margin-bottom: 0.75rem;
        }

        .user-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .user-avatar {
            width: 3rem;
            height: 3rem;
            border-radius: 9999px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            border: 3px solid;
        }

        .user-name {
            font-weight: bold;
        }

        .user-stats {
            font-size: 0.875rem;
            color: #6b7280;
        }

        .progress-bar {
            width: 100%;
            height: 0.75rem;
            background: #e5e7eb;
            border-radius: 9999px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            border-radius: 9999px;
            transition: width 0.3s;
        }

        .achievement-card {
            padding: 1rem;
            border-radius: 0.75rem;
            border: 2px solid;
            margin-bottom: 1rem;
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .achievement-icon {
            font-size: 2.5rem;
        }

        .achievement-info {
            flex: 1;
        }

        .achievement-name {
            font-size: 1.125rem;
            font-weight: bold;
        }

        .achievement-desc {
            font-size: 0.875rem;
            color: #6b7280;
            margin-top: 0.25rem;
        }

        .achievement-points {
            font-size: 0.875rem;
            font-weight: 500;
            color: #b45309;
            margin-top: 0.25rem;
        }

        .check-icon {
            width: 2rem;
            height: 2rem;
            color: #10b981;
        }

        .total-box {
            background: linear-gradient(to right, #dbeafe, #cffafe);
            border: 2px solid #93c5fd;
            border-radius: 0.75rem;
            padding: 1.5rem;
        }

        .total-title {
            font-size: 1.125rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
        }

        .total-points {
            font-size: 2.25rem;
            font-weight: bold;
            background: linear-gradient(to right, #2563eb, #06b6d4);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .total-money {
            font-size: 1.5rem;
            font-weight: bold;
            color: #2563eb;
            margin-top: 0.5rem;
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 1rem;
        }

        .modal {
            background: white;
            border-radius: 1rem;
            max-width: 500px;
            width: 100%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
        }

        .modal-header {
            padding: 1.5rem;
            border-bottom: 2px solid #e5e7eb;
        }

        .modal-body {
            padding: 1.5rem;
        }

        .modal-actions {
            display: flex;
            gap: 0.75rem;
            margin-top: 1.5rem;
        }

        .modal-actions .btn {
            flex: 1;
        }

        .task-clickable {
            cursor: pointer;
            transition: transform 0.2s;
        }

        .task-clickable:hover {
            transform: translateY(-2px);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-content">
                <h1 class="title">St√§dQuest üè†‚ú®</h1>
                <div style="display: flex; gap: 0.75rem; align-items: center;">
                    <button id="saveBtn" class="reset-btn" style="background: #dbeafe; color: #2563eb; border-color: #93c5fd; display: none;" onclick="app.exportData()">üíæ Spara</button>
                    <button id="restoreBtn" class="reset-btn" style="background: #d1fae5; color: #059669; border-color: #6ee7b7; display: none;" onclick="app.importData()">üì• √Öterst√§ll</button>
                    <button id="resetBtn" class="reset-btn" style="display: none;" onclick="app.resetApp()">üîÑ Nollst√§ll</button>
                    <select id="userSelect"></select>
                    <button id="adminBtn" class="reset-btn" style="background: #fef3c7; color: #92400e; border-color: #fbbf24; display: none;" onclick="app.showAdminPanel()">üëë Admin</button>
                </div>
            </div>
        </div>

        <div class="content" id="content"></div>

        <!-- Modal for task actions -->
        <div id="taskModal" style="display: none;"></div>

        <div class="bottom-nav">
            <div class="nav-grid">
                <button class="nav-btn" id="nav-overview" onclick="app.setView('overview')">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/>
                    </svg>
                    <span>Hem</span>
                </button>
                <button class="nav-btn" id="nav-stats" onclick="app.setView('stats')">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"/>
                    </svg>
                    <span>Statistik</span>
                </button>
                <button class="nav-btn" id="nav-completed" onclick="app.setView('completed')">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                    <span>Klara</span>
                </button>
                <button class="nav-btn" id="nav-family" onclick="app.setView('family')">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"/>
                    </svg>
                    <span>Familj</span>
                </button>
            </div>
        </div>
    </div>

    <script>
        const app = {
            currentView: 'overview',
            currentUser: null,
            selectedRoom: null,
            showAllDailyTasks: false,
            showAllRooms: false,
            lastWeekWinner: null, // Sparar f√∂rra veckans vinnare
            lastWeekCheck: null, // N√§r vi senast kollade veckobytet
            
            users: [
                { id: 1, name: 'Patrik', points: 0, unpaidPoints: 0, money: 0, color: '#3b82f6', avatar: 'üë®', isAdmin: true, achievements: [], totalPaidOut: 0, earningsHistory: [], streaks: {}, swishNumber: '0765551636' },
                { id: 2, name: 'Sofie', points: 0, unpaidPoints: 0, money: 0, color: '#ec4899', avatar: 'üë©', isAdmin: true, achievements: [], totalPaidOut: 0, earningsHistory: [], streaks: {}, swishNumber: '0739088431' },
                { id: 3, name: 'Elin', points: 0, unpaidPoints: 0, money: 0, color: '#a855f7', avatar: 'üëß', isAdmin: false, achievements: [], totalPaidOut: 0, earningsHistory: [], streaks: {}, swishNumber: '0700933688' },
                { id: 4, name: 'Edwin', points: 0, unpaidPoints: 0, money: 0, color: '#10b981', avatar: 'üë¶', isAdmin: false, achievements: [], totalPaidOut: 0, earningsHistory: [], streaks: {}, swishNumber: '0769350278' },
                { id: 5, name: 'Ebbe', points: 0, unpaidPoints: 0, money: 0, color: '#f59e0b', avatar: 'üë∂', isAdmin: false, achievements: [], totalPaidOut: 0, earningsHistory: [], streaks: {}, swishNumber: '0760294253' },
                { id: 6, name: 'Tove', points: 0, unpaidPoints: 0, money: 0, color: '#ef4444', avatar: 'üëß', isAdmin: false, achievements: [], totalPaidOut: 0, earningsHistory: [], streaks: {}, swishNumber: '0763291025' },
                { id: 7, name: 'Sigge', points: 0, unpaidPoints: 0, money: 0, color: '#06b6d4', avatar: 'üë¶', isAdmin: false, achievements: [], totalPaidOut: 0, earningsHistory: [], streaks: {}, swishNumber: null }
            ],

            rooms: [
                {
                    id: 1, name: 'K√∂k', icon: 'üç≥', color: '#f59e0b',
                    tasks: [
                        { id: 1, name: 'Diska', points: 10, frequency: 'daily', completed: false, completedBy: null, bookedBy: null, bookedUntil: null },
                        { id: 2, name: 'Torka b√§nkar', points: 5, frequency: 'daily', completed: false, completedBy: null, bookedBy: null, bookedUntil: null },
                        { id: 3, name: 'Dammsuga', points: 10, frequency: 'weekly', completed: false, completedBy: null, bookedBy: null, bookedUntil: null },
                        { id: 4, name: 'T√∂mma sopor', points: 8, frequency: 'weekly', completed: false, completedBy: null, bookedBy: null, bookedUntil: null },
                        { id: 5, name: 'T√∂mma kompost', points: 8, frequency: 'weekly', completed: false, completedBy: null, bookedBy: null, bookedUntil: null },
                        { id: 6, name: 'G√• ut med papper', points: 5, frequency: 'weekly', completed: false, completedBy: null, bookedBy: null, bookedUntil: null },
                        { id: 7, name: 'G√• ut med plast', points: 5, frequency: 'weekly', completed: false, completedBy: null, bookedBy: null, bookedUntil: null },
                        { id: 8, name: 'Torka spis', points: 8, frequency: 'weekly', completed: false, completedBy: null, bookedBy: null, bookedUntil: null },
                        { id: 9, name: 'Rensa kylsk√•p', points: 12, frequency: 'weekly', completed: false, completedBy: null, bookedBy: null, bookedUntil: null },
                        { id: 10, name: 'Torka sk√•pluckor', points: 10, frequency: 'weekly', completed: false, completedBy: null, bookedBy: null, bookedUntil: null },
                        { id: 11, name: 'Torka bord och stolar', points: 6, frequency: 'weekly', completed: false, completedBy: null, bookedBy: null, bookedUntil: null },
                        { id: 12, name: 'Putsa diskb√§nk', points: 7, frequency: 'weekly', completed: false, completedBy: null, bookedBy: null, bookedUntil: null },
                        { id: 115, name: 'Sortera sk√•p (ink. torka ur)', points: 25, frequency: 'weekly', completed: false, completedBy: null, bookedBy: null, bookedUntil: null },
                        { id: 116, name: 'Damma', points: 8, frequency: 'weekly', completed: false, completedBy: null, bookedBy: null, bookedUntil: null },
                        { id: 117, name: 'St√§da k√∂ksmaskiner (kaffebryggare, micro m.m)', points: 10, frequency: 'weekly', completed: false, completedBy: null, bookedBy: null, bookedUntil: null },
                        { id: 118, name: 'Sortera sk√•p √∂ver kyl/frys (ink. torka ur)', points: 10, frequency: 'weekly', completed: false, completedBy: null, bookedBy: null, bookedUntil: null },
                        { id: 119, name: 'Sortera l√•dor (ink. torka ur)', points: 10, frequency: 'weekly', completed: false, completedBy: null, bookedBy: null, bookedUntil: null }
                    ]
                },
                {
                    id: 10, name: 'Hallen', icon: 'üö™', color: '#8b5cf6',
                    tasks: [
                        { id: 83, name: 'Plocka undan skor', points: 5, frequency: 'daily', completed: false, completedBy: null, bookedBy: null, bookedUntil: null },
                        { id: 85, name: 'Dammsuga', points: 10, frequency: 'weekly', completed: false, completedBy: null, bookedBy: null, bookedUntil: null },
                        { id: 86, name: 'Torka golv', points: 10, frequency: 'weekly', completed: false, completedBy: null, bookedBy: null, bookedUntil: null },
                        { id: 87, name: 'Putsa spegel', points: 6, frequency: 'weekly', completed: false, completedBy: null, bookedBy: null, bookedUntil: null },
                        { id: 89, name: 'Torka av ytterd√∂rr', points: 5, frequency: 'weekly', completed: false, completedBy: null, bookedBy: null, bookedUntil: null },
                        { id: 111, name: 'Plocka undan saker', points: 5, frequency: 'daily', completed: false, completedBy: null, bookedBy: null, bookedUntil: null },
                        { id: 112, name: 'Damma', points: 8, frequency: 'weekly', completed: false, completedBy: null, bookedBy: null, bookedUntil: null }
                    ]
                },
                {
                    id: 13, name: 'Grov entr√©', icon: 'üßπ', color: '#78716c',
                    tasks: [
                        { id: 104, name: 'St√§da st√§dsk√•p', points: 10, frequency: 'weekly', completed: false, completedBy: null, bookedBy: null, bookedUntil: null },
                        { id: 105, name: 'Dammsuga', points: 10, frequency: 'weekly', completed: false, completedBy: null, bookedBy: null, bookedUntil: null },
                        { id: 106, name: 'Torka golv', points: 10, frequency: 'weekly', completed: false, completedBy: null, bookedBy: null, bookedUntil: null },
                        { id: 108, name: 'Plocka undan', points: 6, frequency: 'weekly', completed: false, completedBy: null, bookedBy: null, bookedUntil: null },
                        { id: 113, name: 'Sortera skor', points: 8, frequency: 'weekly', completed: false, completedBy: null, bookedBy: null, bookedUntil: null },
                        { id: 114, name: 'Sortera kl√§der', points: 8, frequency: 'weekly', completed: false, completedBy: null, bookedBy: null, bookedUntil: null }
                    ]
                },
                {
                    id: 2, name: 'Vardagsrum', icon: 'üõãÔ∏è', color: '#8b5cf6',
                    tasks: [
                        { id: 13, name: 'Dammsuga', points: 15, frequency: 'weekly', completed: false, completedBy: null, bookedBy: null, bookedUntil: null },
                        { id: 14, name: 'Damma', points: 10, frequency: 'weekly', completed: false, completedBy: null, bookedBy: null, bookedUntil: null },
                        { id: 15, name: 'Plocka undan', points: 5, frequency: 'daily', completed: false, completedBy: null, bookedBy: null, bookedUntil: null },
                        { id: 16, name: 'Torka tv-b√§nk', points: 6, frequency: 'weekly', completed: false, completedBy: null, bookedBy: null, bookedUntil: null },
                        { id: 17, name: 'Vika filtar', points: 3, frequency: 'daily', completed: false, completedBy: null, bookedBy: null, bookedUntil: null },
                        { id: 18, name: 'Putsa f√∂nster', points: 12, frequency: 'weekly', completed: false, completedBy: null, bookedBy: null, bookedUntil: null },
                        { id: 19, name: 'Vattna v√§xter', points: 5, frequency: 'weekly', completed: false, completedBy: null, bookedBy: null, bookedUntil: null },
                        { id: 20, name: 'Torka bord', points: 5, frequency: 'weekly', completed: false, completedBy: null, bookedBy: null, bookedUntil: null }
                    ]
                },
                {
                    id: 11, name: 'Allrum √∂verv√•ning', icon: 'üéÆ', color: '#10b981',
                    tasks: [
                        { id: 90, name: 'Plocka undan', points: 10, frequency: 'daily', completed: false, completedBy: null, bookedBy: null, bookedUntil: null },
                        { id: 91, name: 'Dammsuga', points: 12, frequency: 'weekly', completed: false, completedBy: null, bookedBy: null, bookedUntil: null },
                        { id: 92, name: 'Damma', points: 10, frequency: 'weekly', completed: false, completedBy: null, bookedBy: null, bookedUntil: null },
                        { id: 94, name: 'Torka bord', points: 5, frequency: 'weekly', completed: false, completedBy: null, bookedBy: null, bookedUntil: null }
                    ]
                },
                {
                    id: 12, name: 'Toalett √∂verv√•ning', icon: 'üöΩ', color: '#14b8a6',
                    tasks: [
                        { id: 97, name: 'Skrubba toalett', points: 15, frequency: 'weekly', completed: false, completedBy: null, bookedBy: null, bookedUntil: null },
                        { id: 98, name: 'Putsa spegel', points: 5, frequency: 'weekly', completed: false, completedBy: null, bookedBy: null, bookedUntil: null },
                        { id: 99, name: 'Torka golv', points: 10, frequency: 'weekly', completed: false, completedBy: null, bookedBy: null, bookedUntil: null },
                        { id: 100, name: 'Torka handfat', points: 5, frequency: 'weekly', completed: false, completedBy: null, bookedBy: null, bookedUntil: null },
                        { id: 101, name: 'T√∂mma papperskorg', points: 3, frequency: 'weekly', completed: false, completedBy: null, bookedBy: null, bookedUntil: null },
                        { id: 102, name: 'Byta handdukar', points: 8, frequency: 'weekly', completed: false, completedBy: null, bookedBy: null, bookedUntil: null },
                        { id: 103, name: 'Torka sk√•p', points: 7, frequency: 'weekly', completed: false, completedBy: null, bookedBy: null, bookedUntil: null },
                        { id: 110, name: 'Tv√§tta dusch', points: 15, frequency: 'weekly', completed: false, completedBy: null, bookedBy: null, bookedUntil: null }
                    ]
                },
                {
                    id: 3, name: 'Badrum', icon: 'üöø', color: '#06b6d4',
                    tasks: [
                        { id: 21, name: 'Skrubba toalett', points: 15, frequency: 'weekly', completed: false, completedBy: null, bookedBy: null, bookedUntil: null },
                        { id: 22, name: 'Putsa spegel', points: 5, frequency: 'weekly', completed: false, completedBy: null, bookedBy: null, bookedUntil: null },
                        { id: 23, name: 'Torka golv', points: 10, frequency: 'weekly', completed: false, completedBy: null, bookedBy: null, bookedUntil: null },
                        { id: 24, name: 'Skrubba dusch', points: 15, frequency: 'weekly', completed: false, completedBy: null, bookedBy: null, bookedUntil: null },
                        { id: 25, name: 'Torka handfat', points: 5, frequency: 'weekly', completed: false, completedBy: null, bookedBy: null, bookedUntil: null },
                        { id: 26, name: 'T√∂mma papperskorg', points: 3, frequency: 'weekly', completed: false, completedBy: null, bookedBy: null, bookedUntil: null },
                        { id: 27, name: 'Byta handdukar', points: 8, frequency: 'weekly', completed: false, completedBy: null, bookedBy: null, bookedUntil: null },
                        { id: 28, name: 'Torka sk√•p', points: 7, frequency: 'weekly', completed: false, completedBy: null, bookedBy: null, bookedUntil: null }
                    ]
                },
                {
                    id: 4, name: 'Sovrum (Patrik & Sofie)', icon: 'üõèÔ∏è', color: '#ec4899',
                    tasks: [
                        { id: 29, name: 'B√§dda s√§ngen', points: 5, frequency: 'daily', completed: false, completedBy: null, bookedBy: null, bookedUntil: null },
                        { id: 30, name: 'Plocka undan kl√§der', points: 5, frequency: 'daily', completed: false, completedBy: null, bookedBy: null, bookedUntil: null },
                        { id: 31, name: 'Dammsuga', points: 10, frequency: 'weekly', completed: false, completedBy: null, bookedBy: null, bookedUntil: null },
                        { id: 32, name: 'Damma', points: 8, frequency: 'weekly', completed: false, completedBy: null, bookedBy: null, bookedUntil: null },
                        { id: 33, name: 'Byta lakan', points: 12, frequency: 'weekly', completed: false, completedBy: null, bookedBy: null, bookedUntil: null },
                        { id: 34, name: 'V√§dra', points: 3, frequency: 'daily', completed: false, completedBy: null, bookedBy: null, bookedUntil: null },
                        { id: 35, name: 'Organisera garderob', points: 10, frequency: 'weekly', completed: false, completedBy: null, bookedBy: null, bookedUntil: null },
                        { id: 36, name: 'Putsa f√∂nster', points: 12, frequency: 'weekly', completed: false, completedBy: null, bookedBy: null, bookedUntil: null },
                        { id: 77, name: 'St√§da skrivbord', points: 6, frequency: 'weekly', completed: false, completedBy: null, bookedBy: null, bookedUntil: null }
                    ]
                },
                {
                    id: 5, name: 'Sovrum (Elin)', icon: 'üõèÔ∏è', color: '#a855f7',
                    tasks: [
                        { id: 37, name: 'B√§dda s√§ngen', points: 5, frequency: 'daily', completed: false, completedBy: null, bookedBy: null, bookedUntil: null },
                        { id: 38, name: 'Plocka undan kl√§der', points: 5, frequency: 'daily', completed: false, completedBy: null, bookedBy: null, bookedUntil: null },
                        { id: 39, name: 'Dammsuga', points: 10, frequency: 'weekly', completed: false, completedBy: null, bookedBy: null, bookedUntil: null },
                        { id: 40, name: 'Damma', points: 8, frequency: 'weekly', completed: false, completedBy: null, bookedBy: null, bookedUntil: null },
                        { id: 41, name: 'Byta lakan', points: 12, frequency: 'weekly', completed: false, completedBy: null, bookedBy: null, bookedUntil: null },
                        { id: 42, name: 'V√§dra', points: 3, frequency: 'daily', completed: false, completedBy: null, bookedBy: null, bookedUntil: null },
                        { id: 43, name: 'Organisera garderob', points: 10, frequency: 'weekly', completed: false, completedBy: null, bookedBy: null, bookedUntil: null },
                        { id: 44, name: 'Putsa f√∂nster', points: 12, frequency: 'weekly', completed: false, completedBy: null, bookedBy: null, bookedUntil: null },
                        { id: 78, name: 'St√§da skrivbord', points: 6, frequency: 'weekly', completed: false, completedBy: null, bookedBy: null, bookedUntil: null }
                    ]
                },
                {
                    id: 6, name: 'Sovrum (Edwin)', icon: 'üõèÔ∏è', color: '#10b981',
                    tasks: [
                        { id: 45, name: 'B√§dda s√§ngen', points: 5, frequency: 'daily', completed: false, completedBy: null, bookedBy: null, bookedUntil: null },
                        { id: 46, name: 'Plocka undan kl√§der', points: 5, frequency: 'daily', completed: false, completedBy: null, bookedBy: null, bookedUntil: null },
                        { id: 47, name: 'Dammsuga', points: 10, frequency: 'weekly', completed: false, completedBy: null, bookedBy: null, bookedUntil: null },
                        { id: 48, name: 'Damma', points: 8, frequency: 'weekly', completed: false, completedBy: null, bookedBy: null, bookedUntil: null },
                        { id: 49, name: 'Byta lakan', points: 12, frequency: 'weekly', completed: false, completedBy: null, bookedBy: null, bookedUntil: null },
                        { id: 50, name: 'V√§dra', points: 3, frequency: 'daily', completed: false, completedBy: null, bookedBy: null, bookedUntil: null },
                        { id: 51, name: 'Organisera garderob', points: 10, frequency: 'weekly', completed: false, completedBy: null, bookedBy: null, bookedUntil: null },
                        { id: 52, name: 'Putsa f√∂nster', points: 12, frequency: 'weekly', completed: false, completedBy: null, bookedBy: null, bookedUntil: null },
                        { id: 79, name: 'St√§da skrivbord', points: 6, frequency: 'weekly', completed: false, completedBy: null, bookedBy: null, bookedUntil: null }
                    ]
                },
                {
                    id: 7, name: 'Sovrum (Ebbe)', icon: 'üõèÔ∏è', color: '#f59e0b',
                    tasks: [
                        { id: 53, name: 'B√§dda s√§ngen', points: 5, frequency: 'daily', completed: false, completedBy: null, bookedBy: null, bookedUntil: null },
                        { id: 54, name: 'Plocka undan kl√§der', points: 5, frequency: 'daily', completed: false, completedBy: null, bookedBy: null, bookedUntil: null },
                        { id: 55, name: 'Dammsuga', points: 10, frequency: 'weekly', completed: false, completedBy: null, bookedBy: null, bookedUntil: null },
                        { id: 56, name: 'Damma', points: 8, frequency: 'weekly', completed: false, completedBy: null, bookedBy: null, bookedUntil: null },
                        { id: 57, name: 'Byta lakan', points: 12, frequency: 'weekly', completed: false, completedBy: null, bookedBy: null, bookedUntil: null },
                        { id: 58, name: 'V√§dra', points: 3, frequency: 'daily', completed: false, completedBy: null, bookedBy: null, bookedUntil: null },
                        { id: 59, name: 'Organisera garderob', points: 10, frequency: 'weekly', completed: false, completedBy: null, bookedBy: null, bookedUntil: null },
                        { id: 60, name: 'Putsa f√∂nster', points: 12, frequency: 'weekly', completed: false, completedBy: null, bookedBy: null, bookedUntil: null },
                        { id: 80, name: 'St√§da skrivbord', points: 6, frequency: 'weekly', completed: false, completedBy: null, bookedBy: null, bookedUntil: null }
                    ]
                },
                {
                    id: 8, name: 'Sovrum (Tove)', icon: 'üõèÔ∏è', color: '#ef4444',
                    tasks: [
                        { id: 61, name: 'B√§dda s√§ngen', points: 5, frequency: 'daily', completed: false, completedBy: null, bookedBy: null, bookedUntil: null },
                        { id: 62, name: 'Plocka undan kl√§der', points: 5, frequency: 'daily', completed: false, completedBy: null, bookedBy: null, bookedUntil: null },
                        { id: 63, name: 'Dammsuga', points: 10, frequency: 'weekly', completed: false, completedBy: null, bookedBy: null, bookedUntil: null },
                        { id: 64, name: 'Damma', points: 8, frequency: 'weekly', completed: false, completedBy: null, bookedBy: null, bookedUntil: null },
                        { id: 65, name: 'Byta lakan', points: 12, frequency: 'weekly', completed: false, completedBy: null, bookedBy: null, bookedUntil: null },
                        { id: 66, name: 'V√§dra', points: 3, frequency: 'daily', completed: false, completedBy: null, bookedBy: null, bookedUntil: null },
                        { id: 67, name: 'Organisera garderob', points: 10, frequency: 'weekly', completed: false, completedBy: null, bookedBy: null, bookedUntil: null },
                        { id: 68, name: 'Putsa f√∂nster', points: 12, frequency: 'weekly', completed: false, completedBy: null, bookedBy: null, bookedUntil: null },
                        { id: 81, name: 'St√§da skrivbord', points: 6, frequency: 'weekly', completed: false, completedBy: null, bookedBy: null, bookedUntil: null }
                    ]
                },
                {
                    id: 9, name: 'Sovrum (Sigge)', icon: 'üõèÔ∏è', color: '#06b6d4',
                    tasks: [
                        { id: 69, name: 'B√§dda s√§ngen', points: 5, frequency: 'daily', completed: false, completedBy: null, bookedBy: null, bookedUntil: null },
                        { id: 70, name: 'Plocka undan kl√§der', points: 5, frequency: 'daily', completed: false, completedBy: null, bookedBy: null, bookedUntil: null },
                        { id: 71, name: 'Dammsuga', points: 10, frequency: 'weekly', completed: false, completedBy: null, bookedBy: null, bookedUntil: null },
                        { id: 72, name: 'Damma', points: 8, frequency: 'weekly', completed: false, completedBy: null, bookedBy: null, bookedUntil: null },
                        { id: 73, name: 'Byta lakan', points: 12, frequency: 'weekly', completed: false, completedBy: null, bookedBy: null, bookedUntil: null },
                        { id: 74, name: 'V√§dra', points: 3, frequency: 'daily', completed: false, completedBy: null, bookedBy: null, bookedUntil: null },
                        { id: 75, name: 'Organisera garderob', points: 10, frequency: 'weekly', completed: false, completedBy: null, bookedBy: null, bookedUntil: null },
                        { id: 76, name: 'Putsa f√∂nster', points: 12, frequency: 'weekly', completed: false, completedBy: null, bookedBy: null, bookedUntil: null },
                        { id: 82, name: 'St√§da skrivbord', points: 6, frequency: 'weekly', completed: false, completedBy: null, bookedBy: null, bookedUntil: null }
                    ]
                },
                {
                    id: 14, name: 'Carport', icon: 'üöó', color: '#78716c',
                    tasks: [
                        { id: 200, name: 'Plocka iordning', points: 10, frequency: 'weekly', completed: false, completedBy: null, bookedBy: null, bookedUntil: null },
                        { id: 201, name: 'Panta burkar', points: 8, frequency: 'weekly', completed: false, completedBy: null, bookedBy: null, bookedUntil: null }
                    ]
                },
                {
                    id: 15, name: 'Tv√§ttstuga', icon: 'üß∫', color: '#0ea5e9',
                    tasks: [
                        { id: 210, name: 'Tv√§tta f√∂nster', points: 12, frequency: 'weekly', completed: false, completedBy: null, bookedBy: null, bookedUntil: null },
                        { id: 211, name: 'Plocka undan saker', points: 8, frequency: 'weekly', completed: false, completedBy: null, bookedBy: null, bookedUntil: null },
                        { id: 212, name: 'Tv√§tta kl√§der', points: 15, frequency: 'weekly', completed: false, completedBy: null, bookedBy: null, bookedUntil: null },
                        { id: 213, name: 'Sortera strumpor/underkl√§der', points: 10, frequency: 'weekly', completed: false, completedBy: null, bookedBy: null, bookedUntil: null },
                        { id: 214, name: 'Dammsuga', points: 10, frequency: 'weekly', completed: false, completedBy: null, bookedBy: null, bookedUntil: null },
                        { id: 215, name: 'G√∂r iordning Setup (inkl kabeldragning)', points: 20, frequency: 'weekly', completed: false, completedBy: null, bookedBy: null, bookedUntil: null },
                        { id: 216, name: 'Sortera verktygsb√§nken', points: 15, frequency: 'weekly', completed: false, completedBy: null, bookedBy: null, bookedUntil: null },
                        { id: 217, name: 'Damma', points: 8, frequency: 'weekly', completed: false, completedBy: null, bookedBy: null, bookedUntil: null }
                    ]
                },
                {
                    id: 16, name: 'Tr√§dg√•rd/altan', icon: 'üå≥', color: '#22c55e',
                    tasks: [
                        { id: 220, name: 'Plocka undan saker', points: 10, frequency: 'weekly', completed: false, completedBy: null, bookedBy: null, bookedUntil: null },
                        { id: 221, name: 'Skotta sn√∂', points: 15, frequency: 'weekly', completed: false, completedBy: null, bookedBy: null, bookedUntil: null }
                    ]
                },
                {
                    id: 17, name: '√ñvrigt', icon: 'üì¶', color: '#6b7280',
                    tasks: [
                        { id: 230, name: 'Handla mat', points: 20, frequency: 'weekly', completed: false, completedBy: null, bookedBy: null, bookedUntil: null },
                        { id: 231, name: 'Tippen', points: 15, frequency: 'weekly', completed: false, completedBy: null, bookedBy: null, bookedUntil: null },
                        { id: 232, name: '√Ötervinningen', points: 12, frequency: 'weekly', completed: false, completedBy: null, bookedBy: null, bookedUntil: null }
                    ]
                }
            ],

            achievements: [
                { id: 1, name: 'F√∂rsta steget', description: 'Slutf√∂r din f√∂rsta uppgift', icon: '‚≠ê', points: 5 },
                { id: 2, name: 'St√§d-nyb√∂rjare', description: 'Slutf√∂r 5 uppgifter', icon: 'üåü', points: 5 },
                { id: 3, name: 'St√§d-veteran', description: 'Slutf√∂r 10 uppgifter', icon: 'üèÜ', points: 5 },
                { id: 4, name: 'St√§d-m√§stare', description: 'Slutf√∂r 25 uppgifter', icon: 'üëë', points: 5 },
                { id: 5, name: 'St√§d-legend', description: 'Slutf√∂r 50 uppgifter', icon: 'üíé', points: 5 },
                { id: 6, name: 'Morgonf√•gel', description: 'Slutf√∂r 3 uppgifter f√∂re kl 10', icon: 'üåÖ', points: 5 },
                { id: 7, name: 'Snabbst√§dare', description: 'Slutf√∂r 5 uppgifter p√• en dag', icon: '‚ö°', points: 5 },
                { id: 8, name: 'K√∂ksm√§stare', description: 'Slutf√∂r alla uppgifter i k√∂ket', icon: 'üë®‚Äçüç≥', points: 5 },
                { id: 9, name: 'Vardagsrums-guru', description: 'Slutf√∂r alla uppgifter i vardagsrummet', icon: 'üõãÔ∏è', points: 5 },
                { id: 10, name: 'Badrumsexpert', description: 'Slutf√∂r alla uppgifter i badrummet', icon: 'üöø', points: 5 },
                { id: 11, name: 'Sovrumshj√§lte', description: 'Slutf√∂r alla uppgifter i sovrummet', icon: 'üõèÔ∏è', points: 5 },
                { id: 12, name: 'Perfekt vecka', description: 'Alla dagliga uppgifter 7 dagar i rad', icon: 'üìÖ', points: 5 },
                { id: 13, name: 'Po√§ngj√§gare', description: 'Tj√§na 100 po√§ng', icon: 'üéØ', points: 5 },
                { id: 14, name: 'Miljon√§r', description: 'Tj√§na 500 kr totalt', icon: 'üí∞', points: 5 },
                { id: 15, name: 'Lagspelare', description: 'Hj√§lp till i alla rum samma dag', icon: 'ü§ù', points: 5 },
                { id: 16, name: 'Effektiv', description: 'Slutf√∂r 3 paxade uppgifter inom tiden', icon: '‚è±Ô∏è', points: 5 },
                { id: 17, name: 'Helgst√§dare', description: 'Slutf√∂r 10 uppgifter under en helg', icon: 'üéâ', points: 5 },
                { id: 18, name: 'M√•nadshj√§lte', description: 'Slutf√∂r 100 uppgifter totalt', icon: 'üåô', points: 5 },
                { id: 19, name: 'St√§d-superstj√§rna', description: 'Var den som tj√§nat mest en vecka', icon: '‚≠ê‚ú®', points: 5 },
                { id: 20, name: 'Fullst√§ndig st√§dning', description: 'Alla uppgifter klara samtidigt', icon: 'üèÖ', points: 5 }
            ],

            pointsToMoney: 1.75,
            pointsPerLevel: 75,

            getUserLevel(user) {
                return Math.floor(user.points / this.pointsPerLevel) + 1;
            },

            getUserTitle(user) {
                const level = this.getUserLevel(user);
                if (level >= 25) return 'St√§dgud';
                if (level >= 20) return 'St√§dlegend';
                if (level >= 15) return 'St√§dm√§stare';
                if (level >= 10) return 'St√§dexpert';
                if (level >= 5) return 'St√§dhj√§lte';
                return 'Nyb√∂rjare';
            },

            getProgressToNextLevel(user) {
                const pointsInCurrentLevel = user.points % this.pointsPerLevel;
                return (pointsInCurrentLevel / this.pointsPerLevel) * 100;
            },

            updateStreak(user, taskId) {
                if (!user.streaks) user.streaks = {};
                
                const today = new Date().toDateString();
                const streakKey = `task_${taskId}`;
                
                if (!user.streaks[streakKey]) {
                    user.streaks[streakKey] = { count: 1, lastDate: today };
                } else {
                    const lastDate = new Date(user.streaks[streakKey].lastDate);
                    const todayDate = new Date(today);
                    const diffDays = Math.floor((todayDate - lastDate) / (1000 * 60 * 60 * 24));
                    
                    if (diffDays === 1) {
                        // Consecutive day
                        user.streaks[streakKey].count++;
                        user.streaks[streakKey].lastDate = today;
                    } else if (diffDays === 0) {
                        // Same day, no change
                    } else {
                        // Streak broken, restart
                        user.streaks[streakKey] = { count: 1, lastDate: today };
                    }
                }
                
                return user.streaks[streakKey].count;
            },

            getStreak(user, taskId) {
                if (!user.streaks) return 0;
                const streakKey = `task_${taskId}`;
                
                if (!user.streaks[streakKey]) return 0;
                
                // Check if streak is still valid (last completion was yesterday or today)
                const lastDate = new Date(user.streaks[streakKey].lastDate);
                const today = new Date();
                const diffDays = Math.floor((today - lastDate) / (1000 * 60 * 60 * 24));
                
                if (diffDays > 1) {
                    return 0; // Streak broken
                }
                
                return user.streaks[streakKey].count;
            },

            getWeeklyLeaderboard() {
                const weeklyPoints = this.users.map(user => {
                    const weekPoints = this.getEarningsForPeriod(user, 'week') / this.pointsToMoney;
                    return {
                        ...user,
                        weekPoints: Math.round(weekPoints)
                    };
                }).sort((a, b) => b.weekPoints - a.weekPoints);
                
                return weeklyPoints;
            },

            checkWeeklyWinner() {
                const now = new Date();
                const currentWeekStart = new Date(now);
                const day = currentWeekStart.getDay();
                const diff = currentWeekStart.getDate() - day + (day === 0 ? -6 : 1);
                currentWeekStart.setDate(diff);
                currentWeekStart.setHours(0, 0, 0, 0);
                
                // Om vi aldrig kollat eller om det √§r en ny vecka
                if (!this.lastWeekCheck || new Date(this.lastWeekCheck) < currentWeekStart) {
                    // Det √§r m√•ndag, ny vecka b√∂rjar
                    if (this.lastWeekCheck) {
                        // Kolla f√∂rra veckans vinnare
                        const leaderboard = this.getWeeklyLeaderboard();
                        if (leaderboard.length > 0 && leaderboard[0].weekPoints > 0) {
                            const winner = this.users.find(u => u.id === leaderboard[0].id);
                            if (winner && (!this.lastWeekWinner || this.lastWeekWinner !== winner.id)) {
                                // Ge vinnaren 25p bonus
                                winner.points += 25;
                                winner.unpaidPoints = (winner.unpaidPoints || 0) + 25;
                                winner.money = winner.unpaidPoints * this.pointsToMoney;
                                
                                // L√§gg till i earnings
                                if (!winner.earningsHistory) winner.earningsHistory = [];
                                winner.earningsHistory.push({
                                    amount: 25 * this.pointsToMoney,
                                    timestamp: Date.now()
                                });
                                
                                this.lastWeekWinner = winner.id;
                                this.saveData();
                                
                                alert(`üèÜ ${winner.name} vann f√∂rra veckans t√§vling och f√•r 25p bonus! üéâ`);
                            }
                        }
                    }
                    this.lastWeekCheck = currentWeekStart.toISOString();
                    this.saveData();
                }
            },

            formatDateTime(timestamp) {
                const date = new Date(timestamp);
                const now = new Date();
                const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                const yesterday = new Date(today);
                yesterday.setDate(yesterday.getDate() - 1);
                const taskDate = new Date(date.getFullYear(), date.getMonth(), date.getDate());
                
                const time = date.toLocaleTimeString('sv-SE', { hour: '2-digit', minute: '2-digit' });
                
                if (taskDate.getTime() === today.getTime()) {
                    return `Idag ${time}`;
                } else if (taskDate.getTime() === yesterday.getTime()) {
                    return `Ig√•r ${time}`;
                } else {
                    const dateStr = date.toLocaleDateString('sv-SE', { day: 'numeric', month: 'short' });
                    return `${dateStr} ${time}`;
                }
            },

            getTaskHistory(roomId, taskId) {
                const room = this.rooms.find(r => r.id === roomId);
                const task = room?.tasks.find(t => t.id === taskId);
                if (!task || !task.completionHistory) return [];
                
                return task.completionHistory
                    .map(entry => ({
                        ...entry,
                        userName: this.users.find(u => u.id === entry.userId)?.name || 'Ok√§nd',
                        userAvatar: this.users.find(u => u.id === entry.userId)?.avatar || '‚ùì',
                        userColor: this.users.find(u => u.id === entry.userId)?.color || '#9ca3af'
                    }))
                    .sort((a, b) => b.timestamp - a.timestamp);
            },

            getEarningsForPeriod(user, periodType) {
                if (!user.earningsHistory) return 0;
                
                const now = new Date();
                let startDate;
                
                if (periodType === 'week') {
                    // M√•ndag denna vecka
                    const day = now.getDay();
                    const diff = now.getDate() - day + (day === 0 ? -6 : 1);
                    startDate = new Date(now.setDate(diff));
                    startDate.setHours(0, 0, 0, 0);
                } else if (periodType === 'month') {
                    // F√∂rsta dagen denna m√•nad
                    startDate = new Date(now.getFullYear(), now.getMonth(), 1);
                } else if (periodType === 'year') {
                    // F√∂rsta dagen detta √•r
                    startDate = new Date(now.getFullYear(), 0, 1);
                }
                
                const startTimestamp = startDate.getTime();
                
                return user.earningsHistory
                    .filter(e => e.timestamp >= startTimestamp)
                    .reduce((sum, e) => sum + e.amount, 0);
            },

            getTotalEarnings(user) {
                if (!user.earningsHistory) return 0;
                return user.earningsHistory.reduce((sum, e) => sum + e.amount, 0);
            },

            payoutUser(userId) {
                const user = this.users.find(u => u.id === userId);
                if (!user) return;

                if (user.money <= 0) {
                    alert(`${user.name} har inga pengar att f√• ut!`);
                    return;
                }

                // Sigge har inget Swish - betala kontant
                if (!user.swishNumber) {
                    this.confirmPayout(userId);
                    return;
                }

                // Visa Swish-modal
                this.showSwishModal(userId);
            },

            showSwishModal(userId) {
                const user = this.users.find(u => u.id === userId);
                const amount = user.money.toFixed(0);
                const formattedPhone = user.swishNumber.replace(/(\d{3})(\d{3})(\d{2})(\d{2})/, '$1-$2 $3 $4');
                const period = this.getPaymentPeriod(user);
                const message = `St√§dQuest ${period} - ${user.name}`;
                
                const modal = document.getElementById('taskModal');
                modal.style.display = 'flex';
                modal.innerHTML = `
                    <div class="modal-overlay" onclick="app.closeSwishModal()">
                        <div class="modal" onclick="event.stopPropagation()" style="max-width: 500px; width: 90%;">
                            <div style="background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%); color: white; padding: 2rem; border-radius: 0.75rem 0.75rem 0 0; text-align: center;">
                                <div style="font-size: 3rem; margin-bottom: 0.5rem;">${user.avatar}</div>
                                <h3 style="font-size: 1.5rem; font-weight: bold; margin-bottom: 0.5rem;">${user.name}</h3>
                                <div style="font-size: 2.5rem; font-weight: bold;">${amount} kr</div>
                            </div>
                            
                            <div style="padding: 2rem;">
                                <div style="background: #f0f9ff; border: 2px solid #3b82f6; border-radius: 0.75rem; padding: 1.5rem; margin-bottom: 1.5rem;">
                                    <div style="text-align: center; margin-bottom: 1rem;">
                                        <div style="font-weight: 600; color: #1e40af; margin-bottom: 0.5rem;">Swish-nummer</div>
                                        <div style="font-size: 1.5rem; font-weight: bold; color: #1e3a8a; margin-bottom: 0.5rem;">${formattedPhone}</div>
                                        <button class="btn" style="background: #dbeafe; color: #1e40af; border-color: #3b82f6; padding: 0.5rem 1rem; font-size: 0.875rem;" onclick="navigator.clipboard.writeText('${user.swishNumber}'); alert('Nummer kopierat!')">
                                            üìã Kopiera nummer
                                        </button>
                                    </div>
                                    
                                    <div style="text-align: center; margin-top: 1.5rem;">
                                        <div style="font-weight: 600; color: #1e40af; margin-bottom: 0.75rem;">Scanna QR-kod</div>
                                        <div id="qrcode" style="display: inline-block; padding: 1rem; background: white; border-radius: 0.5rem;"></div>
                                    </div>
                                </div>

                                <div style="background: #fef3c7; border: 2px solid #fbbf24; border-radius: 0.75rem; padding: 1rem; margin-bottom: 1.5rem; text-align: center;">
                                    <div style="font-size: 0.875rem; color: #92400e;">
                                        <strong>Meddelande:</strong> ${message}
                                    </div>
                                </div>

                                <div style="display: flex; gap: 0.75rem;">
                                    <button class="btn btn-secondary" style="flex: 1; padding: 0.75rem;" onclick="app.closeSwishModal()">
                                        Avbryt
                                    </button>
                                    <button class="btn btn-primary" style="flex: 1; padding: 0.75rem;" onclick="app.confirmPayout(${userId})">
                                        ‚úÖ Bekr√§fta utbetalning
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;

                // Generera QR-kod
                setTimeout(() => {
                    const qrContainer = document.getElementById('qrcode');
                    if (qrContainer && window.QRCode) {
                        new QRCode(qrContainer, {
                            text: `swish://payment?phone=${user.swishNumber}&amount=${amount}&message=${encodeURIComponent(message)}`,
                            width: 200,
                            height: 200
                        });
                    }
                }, 100);
            },

            closeSwishModal() {
                const modal = document.getElementById('taskModal');
                modal.style.display = 'none';
                modal.innerHTML = '';
            },

            getPaymentPeriod(user) {
                // H√§mta alla earnings fr√•n denna vecka
                const now = new Date();
                const currentWeekStart = new Date(now);
                const day = currentWeekStart.getDay();
                const diff = currentWeekStart.getDate() - day + (day === 0 ? -6 : 1);
                currentWeekStart.setDate(diff);
                currentWeekStart.setHours(0, 0, 0, 0);
                
                const startTimestamp = currentWeekStart.getTime();
                
                // Filtrera earnings fr√•n denna vecka
                const weeklyEarnings = (user.earningsHistory || [])
                    .filter(e => e.timestamp >= startTimestamp)
                    .sort((a, b) => a.timestamp - b.timestamp);
                
                if (weeklyEarnings.length === 0) {
                    // Ingen earnings denna vecka - anv√§nd dagens datum
                    const formatDate = (date) => {
                        const d = date.getDate();
                        const months = ['jan', 'feb', 'mar', 'apr', 'maj', 'jun', 'jul', 'aug', 'sep', 'okt', 'nov', 'dec'];
                        const m = months[date.getMonth()];
                        return `${d} ${m}`;
                    };
                    return formatDate(now);
                }
                
                // Hitta f√∂rsta och sista datum
                const firstDate = new Date(weeklyEarnings[0].timestamp);
                const lastDate = new Date(weeklyEarnings[weeklyEarnings.length - 1].timestamp);
                
                const formatDate = (date) => {
                    const d = date.getDate();
                    const months = ['jan', 'feb', 'mar', 'apr', 'maj', 'jun', 'jul', 'aug', 'sep', 'okt', 'nov', 'dec'];
                    const m = months[date.getMonth()];
                    return `${d} ${m}`;
                };
                
                // Om samma dag
                if (firstDate.toDateString() === lastDate.toDateString()) {
                    return formatDate(firstDate);
                }
                
                // Om olika dagar
                return `${formatDate(firstDate)}-${formatDate(lastDate)}`;
            },

            confirmPayout(userId) {
                const user = this.users.find(u => u.id === userId);
                if (!user) return;

                const amountToPay = user.money;
                
                if (!confirm(`Har du verkligen ${user.swishNumber ? 'swishat' : 'betalat ut'} ${amountToPay.toFixed(2)} kr till ${user.name}?`)) {
                    return;
                }

                // Spara totalt utbetalat
                if (!user.totalPaidOut) user.totalPaidOut = 0;
                user.totalPaidOut += amountToPay;

                // Nollst√§ll obetalda po√§ng och pengar
                user.unpaidPoints = 0;
                user.money = 0;
                // points beh√•lls f√∂r level!

                // Uppdatera anv√§ndaren
                this.users = this.users.map(u => u.id === userId ? user : u);
                if (this.currentUser.id === userId) {
                    this.currentUser = user;
                }

                this.saveData();
                this.closeSwishModal();
                this.render();
                
                alert(`‚úÖ ${amountToPay.toFixed(2)} kr utbetalt till ${user.name}!`);
            },

            init() {
                this.loadData();
                this.currentUser = this.users[0];
                this.populateUserSelect();
                this.updateAdminButton();
                this.startBookingTimer();
                this.checkWeeklyWinner(); // Kolla om n√•gon vann f√∂rra veckan
                this.render();
            },

            loadData() {
                try {
                    const savedRooms = localStorage.getItem('stadapp_rooms');
                    const savedUsers = localStorage.getItem('stadapp_users');
                    if (savedRooms) this.rooms = JSON.parse(savedRooms);
                    if (savedUsers) this.users = JSON.parse(savedUsers);
                } catch (e) {}
            },

            saveData() {
                try {
                    localStorage.setItem('stadapp_rooms', JSON.stringify(this.rooms));
                    localStorage.setItem('stadapp_users', JSON.stringify(this.users));
                } catch (e) {}
            },

            resetApp() {
                if (confirm('√Ñr du s√§ker p√• att du vill nollst√§lla hela appen? All data kommer att raderas!')) {
                    // Rensa localStorage
                    localStorage.removeItem('stadapp_rooms');
                    localStorage.removeItem('stadapp_users');
                    
                    // Ladda om sidan
                    location.reload();
                }
            },

            exportData() {
                const data = {
                    rooms: this.rooms,
                    users: this.users,
                    exportDate: new Date().toISOString()
                };
                
                const dataStr = JSON.stringify(data, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(dataBlob);
                
                const link = document.createElement('a');
                link.href = url;
                link.download = `stadquest-backup-${new Date().toISOString().split('T')[0]}.json`;
                link.click();
                
                URL.revokeObjectURL(url);
                
                alert('Data sparad! Filen laddas ner nu. Spara den p√• ett s√§kert st√§lle!');
            },

            importData() {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = '.json';
                
                input.onchange = (e) => {
                    const file = e.target.files[0];
                    if (!file) return;
                    
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        try {
                            const data = JSON.parse(event.target.result);
                            
                            if (!data.rooms || !data.users) {
                                alert('Ogiltig backupfil!');
                                return;
                            }
                            
                            if (confirm(`Vill du √•terst√§lla data fr√•n ${data.exportDate ? new Date(data.exportDate).toLocaleDateString('sv-SE') : 'ok√§nt datum'}? Detta kommer att ers√§tta all nuvarande data.`)) {
                                this.rooms = data.rooms;
                                this.users = data.users;
                                this.saveData();
                                
                                alert('Data √•terst√§lld! Laddar om...');
                                location.reload();
                            }
                        } catch (error) {
                            alert('Kunde inte l√§sa filen. Kontrollera att det √§r en giltig St√§dQuest-backup.');
                            console.error(error);
                        }
                    };
                    
                    reader.readAsText(file);
                };
                
                input.click();
            },

            showTaskModal(taskId) {
                // Hitta uppgiften
                let task = null;
                let room = null;
                
                this.rooms.forEach(r => {
                    const foundTask = r.tasks.find(t => t.id === taskId);
                    if (foundTask) {
                        task = foundTask;
                        room = r;
                    }
                });

                if (!task || !room) return;

                const isBookedByMe = task.bookedBy === this.currentUser.id && task.bookedUntil && Date.now() < task.bookedUntil;
                const isBookedByOther = task.bookedBy && task.bookedBy !== this.currentUser.id && task.bookedUntil && Date.now() < task.bookedUntil;
                const bookedUser = isBookedByOther ? this.users.find(u => u.id === task.bookedBy) : null;

                const modal = document.getElementById('taskModal');
                modal.style.display = 'flex';
                modal.innerHTML = `
                    <div class="modal-overlay" onclick="app.closeTaskModal()">
                        <div class="modal" onclick="event.stopPropagation()">
                            <div class="modal-header">
                                <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.5rem;">
                                    <span style="font-size: 2rem;">${room.icon}</span>
                                    <div>
                                        <h3 style="font-size: 1.25rem; font-weight: bold;">${task.name}</h3>
                                        <div style="font-size: 0.875rem; color: #6b7280;">${room.name}</div>
                                    </div>
                                </div>
                                ${task.frequency === 'daily' ? '<span class="badge" style="background: #dbeafe; color: #1e40af; font-size: 0.75rem;">Daglig uppgift</span>' : ''}
                            </div>
                            
                            <div class="modal-body">
                                <div style="background: ${room.color}20; border: 2px solid ${room.color}; border-radius: 0.75rem; padding: 1rem; margin-bottom: 1rem;">
                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                        <div>
                                            <div style="font-size: 0.875rem; color: #6b7280; margin-bottom: 0.25rem;">Bel√∂ning</div>
                                            <div style="font-size: 1.5rem; font-weight: bold; color: ${room.color};">
                                                ${task.points} po√§ng
                                            </div>
                                        </div>
                                        <div style="font-size: 3rem;">üí∞</div>
                                    </div>
                                </div>

                                ${(() => {
                                    const streak = this.getStreak(this.currentUser, task.id);
                                    if (streak > 0) {
                                        return `
                                            <div style="background: linear-gradient(135deg, #fef3c7, #fde68a); border: 2px solid #fbbf24; border-radius: 0.75rem; padding: 1rem; margin-bottom: 1rem; text-align: center;">
                                                <div style="display: flex; align-items: center; justify-content: center; gap: 0.5rem; margin-bottom: 0.25rem;">
                                                    <div style="font-size: 1.5rem;">üî•</div>
                                                    <div style="font-weight: bold; color: #92400e; font-size: 1.125rem;">
                                                        ${streak} dagars streak!
                                                    </div>
                                                </div>
                                                <div style="font-size: 0.875rem; color: #78350f;">
                                                    ${streak % 7 === 6 ? '1 dag kvar till bonus! üéÅ' : `${7 - (streak % 7)} dagar till n√§sta bonus`}
                                                </div>
                                            </div>
                                        `;
                                    }
                                    return '';
                                })()}

                                ${task.completed ? `
                                    <div style="background: #f0fdf4; border: 2px solid #86efac; border-radius: 0.75rem; padding: 1rem; text-align: center;">
                                        <div style="font-size: 2rem; margin-bottom: 0.5rem;">‚úÖ</div>
                                        <div style="font-weight: bold; color: #10b981; margin-bottom: 0.25rem;">Redan slutf√∂rd!</div>
                                        <div style="font-size: 0.875rem; color: #6b7280;">
                                            Av ${this.users.find(u => u.id === task.completedBy)?.name || 'Ok√§nd'}
                                        </div>
                                    </div>
                                ` : isBookedByOther ? `
                                    <div style="background: #fed7aa; border: 2px solid #fb923c; border-radius: 0.75rem; padding: 1rem; text-align: center;">
                                        <div style="font-size: 2rem; margin-bottom: 0.5rem;">üîí</div>
                                        <div style="font-weight: bold; color: #c2410c; margin-bottom: 0.25rem;">Paxad av ${bookedUser?.name}</div>
                                        <div style="font-size: 0.875rem; color: #6b7280;">
                                            ${this.getTimeRemaining(task.bookedUntil)} kvar
                                        </div>
                                    </div>
                                ` : isBookedByMe ? `
                                    <div style="background: #ccfbf1; border: 2px solid #5eead4; border-radius: 0.75rem; padding: 1rem; text-align: center;">
                                        <div style="font-size: 2rem; margin-bottom: 0.5rem;">‚è±Ô∏è</div>
                                        <div style="font-weight: bold; color: #0f766e; margin-bottom: 0.25rem;">Paxad av dig</div>
                                        <div style="font-size: 0.875rem; color: #6b7280;">
                                            ${this.getTimeRemaining(task.bookedUntil)} kvar
                                        </div>
                                    </div>
                                ` : `
                                    <div style="background: #f9fafb; border: 2px solid #e5e7eb; border-radius: 0.75rem; padding: 1rem; text-align: center;">
                                        <div style="font-size: 2rem; margin-bottom: 0.5rem;">üìã</div>
                                        <div style="font-weight: bold; color: #374151; margin-bottom: 0.25rem;">Ledig uppgift</div>
                                        <div style="font-size: 0.875rem; color: #6b7280;">
                                            Ingen har paxat denna √§n
                                        </div>
                                    </div>
                                `}

                                ${task.description ? `
                                    <div style="background: #f0f9ff; border: 2px solid #bae6fd; border-radius: 0.75rem; padding: 1rem; margin-bottom: 1rem;">
                                        <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                                            <div style="font-size: 1.25rem;">üìù</div>
                                            <div style="font-weight: 600; color: #0369a1;">Instruktioner</div>
                                        </div>
                                        <div style="font-size: 0.875rem; color: #374151; white-space: pre-wrap;">
                                            ${task.description}
                                        </div>
                                    </div>
                                ` : ''}

                                ${(() => {
                                    const history = this.getTaskHistory(room.id, task.id);
                                    if (history.length > 0) {
                                        return `
                                            <div style="margin-top: 1.5rem; border-top: 2px solid #e5e7eb; padding-top: 1rem;">
                                                <h4 style="font-weight: 600; margin-bottom: 0.75rem; font-size: 0.9rem; color: #6b7280;">üìÖ Historik (${history.length})</h4>
                                                <div style="max-height: 200px; overflow-y: auto;">
                                                    ${history.slice(0, 10).map(entry => `
                                                        <div style="display: flex; align-items: center; gap: 0.75rem; padding: 0.5rem; background: #f9fafb; border-radius: 0.5rem; margin-bottom: 0.5rem;">
                                                            <div style="
                                                                width: 2rem; 
                                                                height: 2rem; 
                                                                font-size: 1rem;
                                                                background: ${entry.userColor}33; 
                                                                border: 2px solid ${entry.userColor};
                                                                border-radius: 50%;
                                                                display: flex;
                                                                align-items: center;
                                                                justify-content: center;
                                                            ">
                                                                ${entry.userAvatar}
                                                            </div>
                                                            <div style="flex: 1;">
                                                                <div style="font-weight: 500; font-size: 0.875rem;">${entry.userName}</div>
                                                                <div style="font-size: 0.75rem; color: #6b7280;">${this.formatDateTime(entry.timestamp)}</div>
                                                            </div>
                                                            <div style="font-size: 0.75rem; font-weight: 600; color: ${room.color};">
                                                                +${entry.points}p
                                                            </div>
                                                        </div>
                                                    `).join('')}
                                                    ${history.length > 10 ? `
                                                        <div style="text-align: center; font-size: 0.75rem; color: #9ca3af; padding: 0.5rem;">
                                                            +${history.length - 10} fler...
                                                        </div>
                                                    ` : ''}
                                                </div>
                                            </div>
                                        `;
                                    }
                                    return '';
                                })()}

                                <div class="modal-actions">
                                    <button class="btn btn-gray" onclick="app.closeTaskModal()">
                                        Avbryt
                                    </button>
                                    ${!task.completed && !isBookedByOther ? `
                                        ${!isBookedByMe ? `
                                            <button class="btn btn-secondary" onclick="app.bookTaskFromModal(${room.id}, ${task.id})">
                                                ‚è±Ô∏è Paxa
                                            </button>
                                        ` : `
                                            <button class="btn btn-gray" onclick="app.unbookTaskFromModal(${room.id}, ${task.id})">
                                                Avboka
                                            </button>
                                        `}
                                        <button class="btn btn-primary" onclick="app.completeTaskFromModal(${room.id}, ${task.id})">
                                            ‚úÖ Slutf√∂r
                                        </button>
                                    ` : ''}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            },

            closeTaskModal() {
                const modal = document.getElementById('taskModal');
                modal.style.display = 'none';
                modal.innerHTML = '';
            },

            bookTaskFromModal(roomId, taskId) {
                this.bookTask(roomId, taskId);
                this.closeTaskModal();
                // Rendera om s√• att √§ndringar syns
                setTimeout(() => this.render(), 100);
            },

            unbookTaskFromModal(roomId, taskId) {
                this.unbookTask(roomId, taskId);
                this.closeTaskModal();
                // Rendera om s√• att √§ndringar syns
                setTimeout(() => this.render(), 100);
            },

            completeTaskFromModal(roomId, taskId) {
                this.completeTask(roomId, taskId);
                this.closeTaskModal();
                // Rendera om s√• att √§ndringar syns
                setTimeout(() => this.render(), 100);
            },

            showCompletedModal() {
                const completedTasks = [];
                this.rooms.forEach(room => {
                    room.tasks.forEach(task => {
                        if (task.completed) {
                            completedTasks.push({
                                ...task,
                                roomName: room.name,
                                roomIcon: room.icon,
                                roomColor: room.color,
                                roomId: room.id
                            });
                        }
                    });
                });

                const modal = document.getElementById('taskModal');
                modal.style.display = 'flex';
                modal.innerHTML = `
                    <div class="modal-overlay" onclick="app.closeTaskModal()">
                        <div class="modal" onclick="event.stopPropagation()">
                            <div class="modal-header" style="background: linear-gradient(to right, #10b981, #059669); color: white; border: none;">
                                <h3 style="font-size: 1.5rem; font-weight: bold; margin-bottom: 0.5rem;">Slutf√∂rda uppgifter ‚úÖ</h3>
                                <div style="opacity: 0.9;">${completedTasks.length} uppgifter klara</div>
                            </div>
                            
                            <div class="modal-body" style="max-height: 60vh; overflow-y: auto;">
                                ${completedTasks.length === 0 ? `
                                    <div style="text-align: center; padding: 2rem; color: #6b7280;">
                                        <div style="font-size: 3rem; margin-bottom: 1rem;">üéØ</div>
                                        <div>Inga slutf√∂rda uppgifter √§nnu</div>
                                    </div>
                                ` : completedTasks.map(task => {
                                    const completedBy = this.users.find(u => u.id === task.completedBy);
                                    return `
                                        <div class="task-card" style="background: #f0fdf4; border-color: #86efac; margin-bottom: 0.75rem;">
                                            <div class="task-info">
                                                <svg class="check-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width: 1.5rem; height: 1.5rem;">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                                                </svg>
                                                <div>
                                                    <div class="task-name">${task.name}</div>
                                                    <div class="task-room">${task.roomName} ‚Ä¢ ${completedBy ? completedBy.name : 'Ok√§nd'}</div>
                                                </div>
                                            </div>
                                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                                <div class="user-avatar" style="width: 2rem; height: 2rem; font-size: 1rem; background: ${completedBy ? completedBy.color + '33' : '#e5e7eb'}; border-color: ${completedBy ? completedBy.color : '#9ca3af'};">
                                                    ${completedBy ? completedBy.avatar : '?'}
                                                </div>
                                                <span class="badge" style="background: ${task.roomColor}; color: white;">
                                                    +${task.points}p
                                                </span>
                                            </div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                    </div>
                `;
            },

            showRemainingModal() {
                const remainingTasks = [];
                this.rooms.forEach(room => {
                    room.tasks.forEach(task => {
                        if (!task.completed) {
                            remainingTasks.push({
                                ...task,
                                roomName: room.name,
                                roomIcon: room.icon,
                                roomColor: room.color,
                                roomId: room.id
                            });
                        }
                    });
                });

                const modal = document.getElementById('taskModal');
                modal.style.display = 'flex';
                modal.innerHTML = `
                    <div class="modal-overlay" onclick="app.closeTaskModal()">
                        <div class="modal" onclick="event.stopPropagation()">
                            <div class="modal-header" style="background: linear-gradient(to right, #f97316, #ea580c); color: white; border: none;">
                                <h3 style="font-size: 1.5rem; font-weight: bold; margin-bottom: 0.5rem;">Uppgifter kvar üìã</h3>
                                <div style="opacity: 0.9;">${remainingTasks.length} uppgifter att g√∂ra</div>
                            </div>
                            
                            <div class="modal-body" style="max-height: 60vh; overflow-y: auto;">
                                ${remainingTasks.length === 0 ? `
                                    <div style="text-align: center; padding: 2rem; color: #6b7280;">
                                        <div style="font-size: 3rem; margin-bottom: 1rem;">üéâ</div>
                                        <div style="font-weight: bold; margin-bottom: 0.5rem;">Allt klart!</div>
                                        <div>Inga uppgifter kvar att g√∂ra</div>
                                    </div>
                                ` : remainingTasks.map(task => {
                                    const isBooked = task.bookedBy && task.bookedUntil && Date.now() < task.bookedUntil;
                                    const bookedUser = isBooked ? this.users.find(u => u.id === task.bookedBy) : null;
                                    
                                    return `
                                        <div class="task-card task-clickable" onclick="app.closeTaskModal(); app.showTaskModal(${task.id});" style="background: ${task.roomColor}20; border-color: ${task.roomColor}; margin-bottom: 0.75rem;">
                                            <div class="task-info">
                                                <div>
                                                    <div class="task-name">
                                                        ${task.name}
                                                        ${isBooked ? `<span class="badge-white">${bookedUser.id === this.currentUser.id ? '‚è±Ô∏è Paxad av dig' : 'üîí ' + bookedUser.name}</span>` : ''}
                                                    </div>
                                                    <div class="task-room">${task.roomName} ${task.frequency === 'daily' ? '‚Ä¢ Daglig' : ''}</div>
                                                </div>
                                            </div>
                                            <span class="badge" style="background: ${task.roomColor}; color: white;">
                                                ${task.points}p
                                            </span>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                    </div>
                `;
            },

            showBookedModal() {
                const bookedTasks = [];
                this.rooms.forEach(room => {
                    room.tasks.forEach(task => {
                        if (task.bookedBy && task.bookedUntil && Date.now() < task.bookedUntil) {
                            bookedTasks.push({
                                ...task,
                                roomName: room.name,
                                roomIcon: room.icon,
                                roomColor: room.color,
                                roomId: room.id
                            });
                        }
                    });
                });

                const modal = document.getElementById('taskModal');
                modal.style.display = 'flex';
                modal.innerHTML = `
                    <div class="modal-overlay" onclick="app.closeTaskModal()">
                        <div class="modal" onclick="event.stopPropagation()">
                            <div class="modal-header" style="background: linear-gradient(to right, #14b8a6, #0d9488); color: white; border: none;">
                                <h3 style="font-size: 1.5rem; font-weight: bold; margin-bottom: 0.5rem;">Paxade uppgifter ‚è±Ô∏è</h3>
                                <div style="opacity: 0.9;">${bookedTasks.length} uppgifter paxade</div>
                            </div>
                            
                            <div class="modal-body" style="max-height: 60vh; overflow-y: auto;">
                                ${bookedTasks.length === 0 ? `
                                    <div style="text-align: center; padding: 2rem; color: #6b7280;">
                                        <div style="font-size: 3rem; margin-bottom: 1rem;">‚è±Ô∏è</div>
                                        <div>Inga paxade uppgifter just nu</div>
                                    </div>
                                ` : bookedTasks.map(task => {
                                    const bookedUser = this.users.find(u => u.id === task.bookedBy);
                                    const isBookedByMe = task.bookedBy === this.currentUser.id;
                                    
                                    return `
                                        <div class="task-card task-clickable" onclick="app.closeTaskModal(); app.showTaskModal(${task.id});" style="background: ${isBookedByMe ? '#ccfbf1' : '#fed7aa'}; border-color: ${isBookedByMe ? '#5eead4' : '#fb923c'}; margin-bottom: 0.75rem;">
                                            <div class="task-info">
                                                <div>
                                                    <div class="task-name">${task.name}</div>
                                                    <div class="task-room">${task.roomName} ‚Ä¢ ${bookedUser ? bookedUser.name : 'Ok√§nd'}</div>
                                                </div>
                                            </div>
                                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                                <div class="user-avatar" style="width: 2rem; height: 2rem; font-size: 1rem; background: ${bookedUser ? bookedUser.color + '33' : '#e5e7eb'}; border-color: ${bookedUser ? bookedUser.color : '#9ca3af'};">
                                                    ${bookedUser ? bookedUser.avatar : '?'}
                                                </div>
                                                <span class="badge" style="background: ${isBookedByMe ? '#14b8a6' : '#fb923c'}; color: white;">
                                                    ${this.getTimeRemaining(task.bookedUntil)}
                                                </span>
                                            </div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                    </div>
                `;
            },

            populateUserSelect() {
                const select = document.getElementById('userSelect');
                select.innerHTML = this.users.map(user => 
                    `<option value="${user.id}" ${user.id === this.currentUser.id ? 'selected' : ''}>${user.name}</option>`
                ).join('');
                select.onchange = (e) => {
                    this.currentUser = this.users.find(u => u.id === parseInt(e.target.value));
                    this.updateAdminButton();
                    this.render();
                };
                this.updateAdminButton();
            },

            updateAdminButton() {
                const adminBtn = document.getElementById('adminBtn');
                const saveBtn = document.getElementById('saveBtn');
                const restoreBtn = document.getElementById('restoreBtn');
                const resetBtn = document.getElementById('resetBtn');
                
                const isAdmin = this.currentUser.isAdmin;
                
                if (adminBtn) adminBtn.style.display = isAdmin ? 'block' : 'none';
                if (saveBtn) saveBtn.style.display = isAdmin ? 'block' : 'none';
                if (restoreBtn) restoreBtn.style.display = isAdmin ? 'block' : 'none';
                if (resetBtn) resetBtn.style.display = isAdmin ? 'block' : 'none';
            },

            startBookingTimer() {
                setInterval(() => {
                    const now = Date.now();
                    let changed = false;
                    this.rooms.forEach(room => {
                        room.tasks.forEach(task => {
                            if (task.bookedUntil && now > task.bookedUntil) {
                                task.bookedBy = null;
                                task.bookedUntil = null;
                                changed = true;
                            }
                        });
                    });
                    if (changed) {
                        this.saveData();
                        this.render();
                    }
                }, 1000);
            },

            getBookedTasksCount(userId) {
                let count = 0;
                this.rooms.forEach(room => {
                    room.tasks.forEach(task => {
                        if (task.bookedBy === userId && task.bookedUntil && Date.now() < task.bookedUntil) {
                            count++;
                        }
                    });
                });
                return count;
            },

            getTimeRemaining(bookedUntil) {
                const remaining = bookedUntil - Date.now();
                const minutes = Math.floor(remaining / 60000);
                return minutes > 0 ? `${minutes} min` : '<1 min';
            },

            bookTask(roomId, taskId) {
                const bookedCount = this.getBookedTasksCount(this.currentUser.id);
                
                // Kolla om anv√§ndaren har mer √§n 3 bokningar (= har paxat ett helt rum)
                if (bookedCount > 3) {
                    alert('Du har paxat ett helt rum! Du kan inte paxa fler uppgifter f√∂rr√§n dessa √§r klara eller tiden g√•tt ut.');
                    return;
                }
                
                if (bookedCount >= 3) {
                    alert('Du kan max boka 3 uppgifter √•t g√•ngen!');
                    return;
                }

                this.rooms = this.rooms.map(room => {
                    if (room.id === roomId) {
                        const updatedRoom = {
                            ...room,
                            tasks: room.tasks.map(task => {
                                if (task.id === taskId && !task.completed && !task.bookedBy) {
                                    return { ...task, bookedBy: this.currentUser.id, bookedUntil: Date.now() + (60 * 60 * 1000) };
                                }
                                return task;
                            })
                        };
                        // Uppdatera selectedRoom om det √§r samma rum
                        if (this.selectedRoom && this.selectedRoom.id === roomId) {
                            this.selectedRoom = updatedRoom;
                        }
                        return updatedRoom;
                    }
                    return room;
                });
                this.saveData();
                this.render();
            },

            bookWholeRoom(roomId) {
                const room = this.rooms.find(r => r.id === roomId);
                if (!room) return;

                // Kolla om anv√§ndaren redan har n√•gra bokningar
                const bookedCount = this.getBookedTasksCount(this.currentUser.id);
                
                if (bookedCount > 0) {
                    alert('Du m√•ste avboka dina nuvarande uppgifter innan du kan paxa ett helt rum!');
                    return;
                }

                // R√§kna hur m√•nga uppgifter som inte √§r slutf√∂rda eller bokade
                const availableTasks = room.tasks.filter(t => !t.completed && !t.bookedBy);
                
                if (availableTasks.length === 0) {
                    alert('Alla uppgifter i rummet √§r antingen slutf√∂rda eller redan bokade!');
                    return;
                }

                if (!confirm(`Du kommer att paxa ${availableTasks.length} uppgift${availableTasks.length > 1 ? 'er' : ''} i ${room.name} i 1 timme. Efter detta kan du inte paxa fler uppgifter f√∂rr√§n dessa √§r klara. Forts√§tta?`)) {
                    return;
                }

                this.rooms = this.rooms.map(r => {
                    if (r.id === roomId) {
                        const updatedRoom = {
                            ...r,
                            tasks: r.tasks.map(task => {
                                if (!task.completed && !task.bookedBy) {
                                    return { ...task, bookedBy: this.currentUser.id, bookedUntil: Date.now() + (60 * 60 * 1000) };
                                }
                                return task;
                            })
                        };
                        if (this.selectedRoom && this.selectedRoom.id === roomId) {
                            this.selectedRoom = updatedRoom;
                        }
                        return updatedRoom;
                    }
                    return r;
                });

                this.saveData();
                this.render();
                alert(`Hela ${room.name} √§r paxat! ${availableTasks.length} uppgift${availableTasks.length > 1 ? 'er' : ''} bokade i 1 timme.`);
            },

            unbookTask(roomId, taskId) {
                this.rooms = this.rooms.map(room => {
                    if (room.id === roomId) {
                        const updatedRoom = {
                            ...room,
                            tasks: room.tasks.map(task => {
                                if (task.id === taskId && task.bookedBy === this.currentUser.id) {
                                    return { ...task, bookedBy: null, bookedUntil: null };
                                }
                                return task;
                            })
                        };
                        // Uppdatera selectedRoom om det √§r samma rum
                        if (this.selectedRoom && this.selectedRoom.id === roomId) {
                            this.selectedRoom = updatedRoom;
                        }
                        return updatedRoom;
                    }
                    return room;
                });
                this.saveData();
                this.render();
            },

            completeTask(roomId, taskId) {
                // Hitta room och task direkt
                const room = this.rooms.find(r => r.id === roomId);
                if (!room) return;
                
                const task = room.tasks.find(t => t.id === taskId);
                if (!task || task.completed) return;
                
                // Uppdatera anv√§ndare
                const user = this.users.find(u => u.id === this.currentUser.id);
                if (user) {
                    const earnedMoney = task.points * this.pointsToMoney;
                    
                    // L√§gg till earning i historiken
                    if (!user.earningsHistory) user.earningsHistory = [];
                    user.earningsHistory.push({
                        amount: earnedMoney,
                        timestamp: Date.now()
                    });
                    
                    // L√§gg till po√§ng
                    user.points += task.points;
                    if (!user.unpaidPoints) user.unpaidPoints = 0;
                    user.unpaidPoints += task.points;
                    user.money = user.unpaidPoints * this.pointsToMoney;
                    
                    // Uppdatera streak
                    const streakCount = this.updateStreak(user, taskId);
                    
                    // Ge bonus f√∂r streak (varje 7 dagar)
                    if (streakCount > 0 && streakCount % 7 === 0) {
                        const streakBonus = 5;
                        user.points += streakBonus;
                        user.unpaidPoints += streakBonus;
                        user.money = user.unpaidPoints * this.pointsToMoney;
                        
                        // L√§gg till i earnings
                        user.earningsHistory.push({
                            amount: streakBonus * this.pointsToMoney,
                            timestamp: Date.now()
                        });
                        
                        setTimeout(() => {
                            alert(`üî• ${streakCount} dagars streak! Bonus: +${streakBonus}p`);
                        }, 100);
                    }
                    
                    this.currentUser = user;
                }
                
                // L√§gg till i completionHistory
                if (!task.completionHistory) task.completionHistory = [];
                task.completionHistory.push({
                    userId: this.currentUser.id,
                    timestamp: Date.now(),
                    points: task.points
                });
                
                // Uppdatera task status
                task.completed = true;
                task.completedBy = this.currentUser.id;
                task.completedAt = Date.now();
                task.bookedBy = null;
                task.bookedUntil = null;
                
                console.log(`‚úÖ Task "${task.name}" completed. History entries: ${task.completionHistory.length}`);
                
                // Uppdatera selectedRoom om det √§r samma rum
                if (this.selectedRoom && this.selectedRoom.id === roomId) {
                    this.selectedRoom = room;
                }
                
                this.saveData();
                this.checkAchievements();
                this.render();
            },

            checkAchievements() {
                if (!this.currentUser.achievements) {
                    this.currentUser.achievements = [];
                }

                const oldLevel = this.getUserLevel({ points: this.currentUser.points - (this.currentUser.points % this.pointsPerLevel) });
                const newAchievements = [];
                
                // R√§kna slutf√∂rda uppgifter f√∂r anv√§ndaren
                const userCompletedTasks = [];
                this.rooms.forEach(room => {
                    room.tasks.forEach(task => {
                        if (task.completedBy === this.currentUser.id) {
                            userCompletedTasks.push(task);
                        }
                    });
                });
                
                const completedCount = userCompletedTasks.length;

                // 1. F√∂rsta steget - 1 uppgift
                if (completedCount >= 1 && !this.currentUser.achievements.includes(1)) {
                    newAchievements.push(1);
                }
                
                // 2. St√§d-nyb√∂rjare - 5 uppgifter
                if (completedCount >= 5 && !this.currentUser.achievements.includes(2)) {
                    newAchievements.push(2);
                }
                
                // 3. St√§d-veteran - 10 uppgifter
                if (completedCount >= 10 && !this.currentUser.achievements.includes(3)) {
                    newAchievements.push(3);
                }
                
                // 4. St√§d-m√§stare - 25 uppgifter
                if (completedCount >= 25 && !this.currentUser.achievements.includes(4)) {
                    newAchievements.push(4);
                }
                
                // 5. St√§d-legend - 50 uppgifter
                if (completedCount >= 50 && !this.currentUser.achievements.includes(5)) {
                    newAchievements.push(5);
                }
                
                // 13. Po√§ngj√§gare - 100 po√§ng
                if (this.currentUser.points >= 100 && !this.currentUser.achievements.includes(13)) {
                    newAchievements.push(13);
                }
                
                // 14. Miljon√§r - 500 kr
                if (this.currentUser.money >= 500 && !this.currentUser.achievements.includes(14)) {
                    newAchievements.push(14);
                }
                
                // 18. M√•nadshj√§lte - 100 uppgifter
                if (completedCount >= 100 && !this.currentUser.achievements.includes(18)) {
                    newAchievements.push(18);
                }

                // L√§gg till nya achievements och ge po√§ng
                if (newAchievements.length > 0) {
                    newAchievements.forEach(achId => {
                        this.currentUser.achievements.push(achId);
                        const achievement = this.achievements.find(a => a.id === achId);
                        this.currentUser.points += achievement.points;
                        const earnedMoney = achievement.points * this.pointsToMoney;
                        
                        // L√§gg till earning i historiken
                        if (!this.currentUser.earningsHistory) this.currentUser.earningsHistory = [];
                        this.currentUser.earningsHistory.push({
                            amount: earnedMoney,
                            timestamp: Date.now()
                        });
                        
                        if (!this.currentUser.unpaidPoints) this.currentUser.unpaidPoints = 0;
                        this.currentUser.unpaidPoints += achievement.points;
                        this.currentUser.money = this.currentUser.unpaidPoints * this.pointsToMoney;
                    });
                    
                    // Uppdatera users-arrayen
                    this.users = this.users.map(u => 
                        u.id === this.currentUser.id ? this.currentUser : u
                    );
                    
                    this.saveData();
                    
                    // Visa meddelande
                    const achievementNames = newAchievements.map(id => 
                        this.achievements.find(a => a.id === id).name
                    ).join(', ');
                    alert(`üéâ Achievement uppl√•st: ${achievementNames}! +${newAchievements.length * 5}p`);
                }

                // Kolla om anv√§ndaren g√•tt upp i level
                const currentLevel = this.getUserLevel(this.currentUser);
                if (currentLevel > oldLevel) {
                    // Ge 10p f√∂r varje level-up
                    const levelsGained = currentLevel - oldLevel;
                    this.currentUser.points += (levelsGained * 10);
                    const earnedMoney = (levelsGained * 10) * this.pointsToMoney;
                    
                    // L√§gg till earning i historiken
                    if (!this.currentUser.earningsHistory) this.currentUser.earningsHistory = [];
                    this.currentUser.earningsHistory.push({
                        amount: earnedMoney,
                        timestamp: Date.now()
                    });
                    
                    if (!this.currentUser.unpaidPoints) this.currentUser.unpaidPoints = 0;
                    this.currentUser.unpaidPoints += (levelsGained * 10);
                    this.currentUser.money = this.currentUser.unpaidPoints * this.pointsToMoney;
                    
                    // Uppdatera users-arrayen
                    this.users = this.users.map(u => 
                        u.id === this.currentUser.id ? this.currentUser : u
                    );
                    
                    this.saveData();
                    
                    const title = this.getUserTitle(this.currentUser);
                    const oldTitle = this.getUserTitle({ points: (oldLevel - 1) * this.pointsPerLevel });
                    
                    if (title !== oldTitle && currentLevel % 5 === 0) {
                        alert(`üéä Grattis! Du √§r nu Level ${currentLevel} och har f√•tt titeln "${title}"! +${levelsGained * 10}p (${(levelsGained * 10 * this.pointsToMoney).toFixed(2)} kr) üéä`);
                    } else {
                        alert(`‚¨ÜÔ∏è Level Up! Du √§r nu Level ${currentLevel}! +${levelsGained * 10}p (${(levelsGained * 10 * this.pointsToMoney).toFixed(2)} kr)`);
                    }
                }
            },

            getDailyTasks() {
                const dailyTasks = [];
                this.rooms.forEach(room => {
                    room.tasks.forEach(task => {
                        if (task.frequency === 'daily' && !task.completed) {
                            dailyTasks.push({ ...task, room: room.name, roomColor: room.color });
                        }
                    });
                });
                return dailyTasks;
            },

            getCompletedTasks() {
                return this.rooms.reduce((total, room) => total + room.tasks.filter(t => t.completed).length, 0);
            },

            getTotalTasks() {
                return this.rooms.reduce((total, room) => total + room.tasks.length, 0);
            },

            getTotalBookedTasks() {
                let count = 0;
                this.rooms.forEach(room => {
                    room.tasks.forEach(task => {
                        if (task.bookedBy && task.bookedUntil && Date.now() < task.bookedUntil) {
                            count++;
                        }
                    });
                });
                return count;
            },

            setView(view) {
                this.currentView = view;
                this.render();
            },

            selectRoom(room) {
                // Om det √§r ett sovrum, visa en meny f√∂r att v√§lja vilket sovrum
                if (room.name.startsWith('Sovrum')) {
                    this.currentView = 'bedroom-select';
                    this.render();
                } else {
                    this.selectedRoom = room;
                    this.currentView = 'room';
                    this.render();
                }
            },

            selectBedroom(bedroomId) {
                this.selectedRoom = this.rooms.find(r => r.id === bedroomId);
                this.currentView = 'room';
                this.render();
            },

            toggleDailyTasks() {
                this.showAllDailyTasks = !this.showAllDailyTasks;
                this.render();
            },

            toggleRooms() {
                this.showAllRooms = !this.showAllRooms;
                this.render();
            },

            editUserProfile(userId) {
                const user = this.users.find(u => u.id === userId);
                if (!user) return;

                const emojis = ['üë®', 'üë©', 'üë¶', 'üëß', 'üë∂', 'üßë', 'üë¥', 'üëµ', 'üßí', 'üë®‚Äçü¶∞', 'üë©‚Äçü¶∞', 'üë®‚Äçü¶±', 'üë©‚Äçü¶±', 'üë®‚Äçü¶≤', 'üë©‚Äçü¶≤', 'üë®‚Äçü¶≥', 'üë©‚Äçü¶≥', 'üßî', 'üßî‚Äç‚ôÄÔ∏è', 'üßî‚Äç‚ôÇÔ∏è', 'ü¶∏', 'ü¶∏‚Äç‚ôÄÔ∏è', 'ü¶∏‚Äç‚ôÇÔ∏è', 'ü¶π', 'ü¶π‚Äç‚ôÄÔ∏è', 'ü¶π‚Äç‚ôÇÔ∏è', 'üßô', 'üßô‚Äç‚ôÄÔ∏è', 'üßô‚Äç‚ôÇÔ∏è', 'üßö', 'üßö‚Äç‚ôÄÔ∏è', 'üßö‚Äç‚ôÇÔ∏è', 'üßõ', 'üßõ‚Äç‚ôÄÔ∏è', 'üßõ‚Äç‚ôÇÔ∏è', 'üßú', 'üßú‚Äç‚ôÄÔ∏è', 'üßú‚Äç‚ôÇÔ∏è', 'üßù', 'üßù‚Äç‚ôÄÔ∏è', 'üßù‚Äç‚ôÇÔ∏è', 'ü§¥', 'üë∏', 'üëº', 'üéÖ', 'ü§∂', 'üßë‚ÄçüéÑ', 'ü¶å', 'üê∂', 'üê±', 'üê≠', 'üêπ', 'üê∞', 'ü¶ä', 'üêª', 'üêº', 'üê®', 'üêØ', 'ü¶Å', 'üêÆ', 'üê∑', 'üê∏', 'üêµ', 'üêî', 'üêß', 'üê¶', 'üê§', 'ü¶Ü', 'ü¶Ö', 'ü¶â', 'ü¶á', 'üê∫', 'üêó', 'üê¥', 'ü¶Ñ', 'üêù', 'üêõ', 'ü¶ã', 'üêå', 'üêû', 'üêú', 'ü¶ü', 'ü¶ó', 'üï∑', 'ü¶Ç', 'üê¢', 'üêç', 'ü¶é', 'ü¶ñ', 'ü¶ï', 'üêô', 'ü¶ë', 'ü¶ê', 'ü¶û', 'ü¶Ä', 'üê°', 'üê†', 'üêü', 'üê¨', 'üê≥', 'üêã', 'ü¶à', 'üêä', 'üêÖ', 'üêÜ', 'ü¶ì', 'ü¶ç', 'ü¶ß', 'üêò', 'ü¶õ', 'ü¶è', 'üê™', 'üê´', 'ü¶í', 'ü¶ò', 'üêÉ', 'üêÇ', 'üêÑ', 'üêé', 'üêñ', 'üêè', 'üêë', 'ü¶ô', 'üêê', 'ü¶å', 'üêï', 'üê©', 'ü¶Æ', 'üêï‚Äçü¶∫', 'üêà', 'üêà‚Äç‚¨õ', 'üêì', 'ü¶É', 'ü¶ö', 'ü¶ú', 'ü¶¢', 'ü¶©', 'üïä', 'üêá', 'ü¶ù', 'ü¶®', 'ü¶°', 'ü¶¶', 'ü¶•', 'üêÅ', 'üêÄ', 'üêø', 'ü¶î', 'üå∏', 'üå∫', 'üåª', 'üåº', 'üå∑', 'üåπ', 'ü•Ä', 'üèµ', 'üíê', 'üçÑ', 'üåæ', 'üí´', '‚≠ê', 'üåü', '‚ú®', '‚ö°', '‚òÑ', 'üí•', 'üî•', 'üåà', '‚òÄ', 'üå§', '‚õÖ', 'üå•', '‚òÅ', 'üå¶', 'üåß', '‚õà', 'üå©', 'üå®', '‚ùÑ', '‚òÉ', '‚õÑ', 'üå¨', 'üí®', 'üíß', 'üí¶', '‚òî', 'üåä'];
                
                let selectedEmoji = user.avatar;
                
                const emojiGrid = emojis.map(emoji => 
                    `<button onclick="window.tempSelectedEmoji='${emoji}'; document.querySelectorAll('.emoji-btn').forEach(b => b.style.background='white'); event.target.style.background='#dbeafe';" class="emoji-btn" style="font-size: 2rem; padding: 0.5rem; border: 2px solid #e5e7eb; border-radius: 0.5rem; background: ${emoji === selectedEmoji ? '#dbeafe' : 'white'}; cursor: pointer;">${emoji}</button>`
                ).join('');

                const modal = document.getElementById('taskModal');
                modal.style.display = 'flex';
                modal.innerHTML = `
                    <div class="modal-overlay" onclick="app.closeUserProfileModal()">
                        <div class="modal" onclick="event.stopPropagation()" style="max-width: 500px; max-height: 80vh; overflow-y: auto;">
                            <h3 style="font-size: 1.25rem; font-weight: bold; margin-bottom: 1rem;">Redigera ${user.name}</h3>
                            
                            <div style="margin-bottom: 1.5rem;">
                                <label style="display: block; font-weight: 500; margin-bottom: 0.5rem;">V√§lj avatar:</label>
                                <div style="display: grid; grid-template-columns: repeat(8, 1fr); gap: 0.5rem;">
                                    ${emojiGrid}
                                </div>
                            </div>

                            <div style="display: flex; gap: 0.75rem;">
                                <button class="btn btn-primary" onclick="app.saveUserProfile(${userId})">Spara</button>
                                <button class="btn btn-gray" onclick="app.closeUserProfileModal()">Avbryt</button>
                            </div>
                        </div>
                    </div>
                `;
                window.tempSelectedEmoji = selectedEmoji;
            },

            closeUserProfileModal() {
                const modal = document.getElementById('taskModal');
                modal.style.display = 'none';
                modal.innerHTML = '';
            },

            saveUserProfile(userId) {
                const newAvatar = window.tempSelectedEmoji;
                
                this.users = this.users.map(user => {
                    if (user.id === userId) {
                        return { ...user, avatar: newAvatar };
                    }
                    return user;
                });

                this.saveData();
                this.closeUserProfileModal();
                this.render();
            },

            showAdminPanel() {
                if (!this.currentUser.isAdmin) {
                    alert('Du har inte beh√∂righet till admin-panelen!');
                    return;
                }

                const modal = document.getElementById('taskModal');
                modal.style.display = 'flex';
                modal.innerHTML = `
                    <div class="modal-overlay" onclick="app.closeAdminPanel()">
                        <div class="modal" onclick="event.stopPropagation()" style="max-width: 500px; width: 90%; max-height: 90vh; overflow-y: auto; padding: 2rem;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                                <h3 style="font-size: 1.5rem; font-weight: bold; color: #92400e;">üëë Admin</h3>
                                <button onclick="app.closeAdminPanel()" style="background: none; border: none; font-size: 2rem; cursor: pointer; color: #6b7280; line-height: 1; padding: 0; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; border-radius: 50%; transition: all 0.2s;" onmouseover="this.style.background='#f3f4f6'" onmouseout="this.style.background='none'">√ó</button>
                            </div>
                            
                            <div style="display: flex; flex-direction: column; gap: 0.75rem;">
                                <button class="btn" style="background: #fef3c7; color: #92400e; border-color: #fbbf24; padding: 1rem; font-size: 0.95rem; display: flex; align-items: center; justify-content: center; gap: 0.5rem;" onclick="app.showResetTasksMenu()">
                                    <span style="font-size: 1.25rem;">üîÑ</span>
                                    <span>√Öterst√§ll</span>
                                </button>
                                
                                <button class="btn" style="background: #dbeafe; color: #1e40af; border-color: #93c5fd; padding: 1rem; font-size: 0.95rem; display: flex; align-items: center; justify-content: center; gap: 0.5rem;" onclick="app.showEditTasksMenu()">
                                    <span style="font-size: 1.25rem;">‚úèÔ∏è</span>
                                    <span>Redigera</span>
                                </button>
                                
                                <button class="btn" style="background: #d1fae5; color: #065f46; border-color: #6ee7b7; padding: 1rem; font-size: 0.95rem; display: flex; align-items: center; justify-content: center; gap: 0.5rem;" onclick="app.showAddTaskMenu()">
                                    <span style="font-size: 1.25rem;">‚ûï</span>
                                    <span>L√§gg till</span>
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            },

            closeAdminPanel() {
                const modal = document.getElementById('taskModal');
                modal.style.display = 'none';
                modal.innerHTML = '';
            },

            showResetTasksMenu() {
                // R√§kna slutf√∂rda uppgifter
                const dailyCompleted = this.rooms.reduce((sum, room) => 
                    sum + room.tasks.filter(t => t.completed && t.frequency === 'daily').length, 0
                );
                const weeklyCompleted = this.rooms.reduce((sum, room) => 
                    sum + room.tasks.filter(t => t.completed && t.frequency === 'weekly').length, 0
                );
                
                const modal = document.getElementById('taskModal');
                modal.innerHTML = `
                    <div class="modal-overlay" onclick="app.closeAdminPanel()">
                        <div class="modal" onclick="event.stopPropagation()" style="max-width: 95%; width: 1000px; max-height: 90vh; overflow-y: auto; padding: 2rem;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                                <h3 style="font-size: 1.25rem; font-weight: bold;">üîÑ √Öterst√§ll uppgifter</h3>
                                <button onclick="app.showAdminPanel()" style="background: none; border: none; font-size: 2rem; cursor: pointer; color: #6b7280; line-height: 1; padding: 0; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; border-radius: 50%; transition: all 0.2s;" onmouseover="this.style.background='#f3f4f6'" onmouseout="this.style.background='none'">√ó</button>
                            </div>
                            
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; margin-bottom: 1.5rem;">
                                <button class="btn btn-primary" style="padding: 0.6rem; font-size: 0.9rem; display: flex; flex-direction: column; align-items: center; gap: 0.25rem;" onclick="app.resetAllDailyTasks()">
                                    <span>√Öterst√§ll alla dagliga</span>
                                    <span style="font-size: 0.8rem; opacity: 0.9;">(${dailyCompleted} st)</span>
                                </button>
                                <button class="btn btn-primary" style="padding: 0.6rem; font-size: 0.9rem; display: flex; flex-direction: column; align-items: center; gap: 0.25rem;" onclick="app.resetAllWeeklyTasks()">
                                    <span>√Öterst√§ll alla veckovisa</span>
                                    <span style="font-size: 0.8rem; opacity: 0.9;">(${weeklyCompleted} st)</span>
                                </button>
                            </div>

                            <div style="border: 2px solid #e5e7eb; border-radius: 0.75rem; overflow: hidden;">
                                ${this.rooms.map((room, index) => {
                                    const completedCount = room.tasks.filter(t => t.completed).length;
                                    return `
                                    <div>
                                        <div onclick="window.selectedResetRoomId = window.selectedResetRoomId === ${room.id} ? null : ${room.id}; app.showResetTasksMenu();" style="
                                            padding: 0.75rem 1rem;
                                            background: ${window.selectedResetRoomId === room.id ? room.color + '15' : 'white'};
                                            border-bottom: ${index < this.rooms.length - 1 || window.selectedResetRoomId === room.id ? '2px solid #e5e7eb' : 'none'};
                                            cursor: pointer;
                                            display: flex;
                                            justify-content: space-between;
                                            align-items: center;
                                            transition: background 0.2s;
                                        " onmouseover="if(${window.selectedResetRoomId !== room.id}) this.style.background='#f9fafb'" onmouseout="if(${window.selectedResetRoomId !== room.id}) this.style.background='white'">
                                            <div style="display: flex; align-items: center; gap: 0.75rem;">
                                                <span style="font-size: 1.5rem;">${room.icon}</span>
                                                <span style="font-weight: 500;">${room.name}</span>
                                                <span style="font-size: 0.8rem; color: #6b7280; background: ${completedCount > 0 ? '#dcfce7' : '#f3f4f6'}; padding: 0.25rem 0.5rem; border-radius: 0.25rem;">${completedCount} klara</span>
                                            </div>
                                            <span style="font-size: 1.25rem; color: #6b7280;">${window.selectedResetRoomId === room.id ? '‚ñº' : '‚ñ∂'}</span>
                                        </div>
                                        
                                        ${window.selectedResetRoomId === room.id ? `
                                            <div style="padding: 1rem; background: #f9fafb;">
                                                <button class="btn btn-secondary" style="width: 100%; padding: 0.5rem; font-size: 0.85rem; margin-bottom: 0.75rem;" onclick="event.stopPropagation(); app.resetRoom(${room.id})">
                                                    üîÑ √Öterst√§ll hela ${room.name} (${completedCount} st)
                                                </button>
                                                ${room.tasks.map(task => `
                                                    <div style="background: ${task.completed ? '#dcfce7' : 'white'}; border: 2px solid ${task.completed ? '#86efac' : '#e5e7eb'}; border-radius: 0.5rem; padding: 0.6rem; margin-bottom: 0.4rem; display: flex; justify-content: space-between; align-items: center;">
                                                        <div style="flex: 1;">
                                                            <div style="font-weight: 500; font-size: 0.9rem; display: flex; align-items: center; gap: 0.5rem;">
                                                                ${task.completed ? '‚úÖ' : '‚¨ú'} ${task.name}
                                                            </div>
                                                            <div style="font-size: 0.8rem; color: #6b7280;">
                                                                ${task.points}p ¬∑ ${task.frequency === 'daily' ? 'Daglig' : 'Veckovis'}
                                                                ${task.completed && task.completedBy ? ` ¬∑ ${this.users.find(u => u.id === task.completedBy)?.name}` : ''}
                                                            </div>
                                                        </div>
                                                        ${task.completed ? `
                                                            <button class="btn" style="background: #fef3c7; color: #92400e; border-color: #fbbf24; padding: 0.4rem 0.8rem; font-size: 0.85rem; white-space: nowrap;" onclick="event.stopPropagation(); app.resetSingleTask(${room.id}, ${task.id})">
                                                                üîÑ
                                                            </button>
                                                        ` : `
                                                            <div style="color: #9ca3af; font-size: 0.8rem; padding: 0.4rem;">Ej klar</div>
                                                        `}
                                                    </div>
                                                `).join('')}
                                            </div>
                                        ` : ''}
                                    </div>
                                `;
                                }).join('')}
                            </div>
                        </div>
                    </div>
                `;
            },

            resetAllDailyTasks() {
                if (!confirm('Vill du √•terst√§lla alla dagliga uppgifter? De blir markerade som ogjorda.')) return;
                
                this.rooms.forEach(room => {
                    room.tasks.forEach(task => {
                        if (task.frequency === 'daily') {
                            task.completed = false;
                            task.completedBy = null;
                            task.completedAt = null;
                            // completionHistory bevaras!
                        }
                    });
                });
                
                this.saveData();
                this.render();
                alert('Alla dagliga uppgifter √•terst√§llda!');
                this.closeAdminPanel();
            },

            resetAllWeeklyTasks() {
                if (!confirm('Vill du √•terst√§lla alla veckovisa uppgifter? De blir markerade som ogjorda.')) return;
                
                this.rooms.forEach(room => {
                    room.tasks.forEach(task => {
                        if (task.frequency === 'weekly') {
                            task.completed = false;
                            task.completedBy = null;
                            task.completedAt = null;
                            // completionHistory bevaras!
                        }
                    });
                });
                
                this.saveData();
                this.render();
                alert('Alla veckovisa uppgifter √•terst√§llda!');
                this.closeAdminPanel();
            },

            resetAllTasks() {
                if (!confirm('Vill du √•terst√§lla ALLA uppgifter? De blir markerade som ogjorda.')) return;
                
                this.rooms.forEach(room => {
                    room.tasks.forEach(task => {
                        task.completed = false;
                        task.completedBy = null;
                        task.completedAt = null;
                        task.bookedBy = null;
                        task.bookedUntil = null;
                        // completionHistory bevaras!
                    });
                });
                
                this.saveData();
                this.render();
                alert('Alla uppgifter √•terst√§llda!');
                this.closeAdminPanel();
            },

            resetRoom(roomId) {
                const room = this.rooms.find(r => r.id === roomId);
                if (!room) return;
                
                if (!confirm(`Vill du √•terst√§lla alla uppgifter i ${room.name}?`)) return;
                
                room.tasks.forEach(task => {
                    task.completed = false;
                    task.completedBy = null;
                    task.completedAt = null;
                    task.bookedBy = null;
                    task.bookedUntil = null;
                    // completionHistory bevaras!
                });
                
                this.saveData();
                this.render();
                alert(`${room.name} √•terst√§llt!`);
                this.showResetTasksMenu();
            },

            resetSingleTask(roomId, taskId) {
                const room = this.rooms.find(r => r.id === roomId);
                const task = room?.tasks.find(t => t.id === taskId);
                if (!task) return;

                task.completed = false;
                task.completedBy = null;
                task.completedAt = null;
                task.bookedBy = null;
                task.bookedUntil = null;
                // completionHistory bevaras!
                
                console.log(`üîÑ Task "${task.name}" reset. History entries preserved: ${task.completionHistory?.length || 0}`);

                this.saveData();
                this.render();
                this.showResetTasksMenu();
            },

            undoCompletedTask(roomId, taskId) {
                const room = this.rooms.find(r => r.id === roomId);
                const task = room?.tasks.find(t => t.id === taskId);
                if (!task || !task.completed) return;

                const completedByUser = this.users.find(u => u.id === task.completedBy);
                if (!completedByUser) {
                    alert('Kunde inte hitta anv√§ndaren som slutf√∂rde uppgiften!');
                    return;
                }

                if (!confirm(`Vill du √•ngra "${task.name}" som slutf√∂rdes av ${completedByUser.name}? Po√§ng och pengar kommer att dras tillbaka.`)) {
                    return;
                }

                // Dra tillbaka po√§ng och pengar
                completedByUser.points -= task.points;
                if (completedByUser.unpaidPoints) {
                    completedByUser.unpaidPoints -= task.points;
                    if (completedByUser.unpaidPoints < 0) completedByUser.unpaidPoints = 0;
                }
                completedByUser.money = (completedByUser.unpaidPoints || 0) * this.pointsToMoney;
                
                // Ta bort fr√•n earningsHistory (senaste posten f√∂r denna uppgift)
                if (completedByUser.earningsHistory) {
                    const earnedAmount = task.points * this.pointsToMoney;
                    const index = completedByUser.earningsHistory.findIndex(e => 
                        Math.abs(e.amount - earnedAmount) < 0.01 && 
                        e.timestamp === task.completedAt
                    );
                    if (index !== -1) {
                        completedByUser.earningsHistory.splice(index, 1);
                    }
                }

                // Ta bort fr√•n completionHistory
                if (task.completionHistory) {
                    const index = task.completionHistory.findIndex(e => 
                        e.userId === task.completedBy && 
                        e.timestamp === task.completedAt
                    );
                    if (index !== -1) {
                        task.completionHistory.splice(index, 1);
                    }
                }

                // √Öterst√§ll uppgiften
                task.completed = false;
                task.completedBy = null;
                task.completedAt = null;

                // Uppdatera currentUser om det √§r samma person
                if (this.currentUser.id === completedByUser.id) {
                    this.currentUser = completedByUser;
                }

                this.saveData();
                this.render();
                
                alert(`‚úÖ Uppgiften √•ngrad! ${completedByUser.name} har f√•tt -${task.points}p (-${(task.points * this.pointsToMoney).toFixed(2)} kr)`);
            },

            showEditTasksMenu() {
                const modal = document.getElementById('taskModal');
                modal.innerHTML = `
                    <div class="modal-overlay" onclick="app.closeAdminPanel()">
                        <div class="modal" onclick="event.stopPropagation()" style="max-width: 95%; width: 1000px; max-height: 90vh; overflow-y: auto; padding: 2rem;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                                <h3 style="font-size: 1.25rem; font-weight: bold;">‚úèÔ∏è Redigera uppgifter</h3>
                                <button onclick="app.showAdminPanel()" style="background: none; border: none; font-size: 2rem; cursor: pointer; color: #6b7280; line-height: 1; padding: 0; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; border-radius: 50%; transition: all 0.2s;" onmouseover="this.style.background='#f3f4f6'" onmouseout="this.style.background='none'">√ó</button>
                            </div>

                            <div style="border: 2px solid #e5e7eb; border-radius: 0.75rem; overflow: hidden;">
                                ${this.rooms.map((room, index) => `
                                    <div>
                                        <div onclick="window.selectedEditRoomId = window.selectedEditRoomId === ${room.id} ? null : ${room.id}; app.showEditTasksMenu();" style="
                                            padding: 0.75rem 1rem;
                                            background: ${window.selectedEditRoomId === room.id ? room.color + '15' : 'white'};
                                            border-bottom: ${index < this.rooms.length - 1 || window.selectedEditRoomId === room.id ? '2px solid #e5e7eb' : 'none'};
                                            cursor: pointer;
                                            display: flex;
                                            justify-content: space-between;
                                            align-items: center;
                                            transition: background 0.2s;
                                        " onmouseover="if(${window.selectedEditRoomId !== room.id}) this.style.background='#f9fafb'" onmouseout="if(${window.selectedEditRoomId !== room.id}) this.style.background='white'">
                                            <div style="display: flex; align-items: center; gap: 0.75rem;">
                                                <span style="font-size: 1.5rem;">${room.icon}</span>
                                                <span style="font-weight: 500;">${room.name}</span>
                                            </div>
                                            <span style="font-size: 1.25rem; color: #6b7280;">${window.selectedEditRoomId === room.id ? '‚ñº' : '‚ñ∂'}</span>
                                        </div>
                                        
                                        ${window.selectedEditRoomId === room.id ? `
                                            <div style="padding: 1rem; background: #f9fafb;">
                                                ${room.tasks.map(task => `
                                                    <div style="background: white; border: 2px solid ${room.color}; border-radius: 0.5rem; padding: 0.6rem; margin-bottom: 0.4rem; display: flex; justify-content: space-between; align-items: center;">
                                                        <div style="flex: 1;">
                                                            <div style="font-weight: 500; font-size: 0.9rem;">${task.name}</div>
                                                            <div style="font-size: 0.8rem; color: #6b7280;">
                                                                ${task.points}p ¬∑ ${task.frequency === 'daily' ? 'Daglig' : 'Veckovis'}
                                                            </div>
                                                        </div>
                                                        <div style="display: flex; gap: 0.4rem;">
                                                            <button class="btn btn-secondary" style="padding: 0.4rem 0.7rem; font-size: 0.85rem;" onclick="event.stopPropagation(); app.editTask(${room.id}, ${task.id})">
                                                                ‚úèÔ∏è
                                                            </button>
                                                            <button class="btn" style="background: #fee2e2; color: #991b1b; border-color: #fecaca; padding: 0.4rem 0.7rem; font-size: 0.85rem;" onclick="event.stopPropagation(); app.deleteTask(${room.id}, ${task.id})">
                                                                üóëÔ∏è
                                                            </button>
                                                        </div>
                                                    </div>
                                                `).join('')}
                                            </div>
                                        ` : ''}
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                `;
            },

            editTask(roomId, taskId) {
                const room = this.rooms.find(r => r.id === roomId);
                const task = room.tasks.find(t => t.id === taskId);
                if (!task) return;

                const modal = document.getElementById('taskModal');
                modal.innerHTML = `
                    <div class="modal-overlay" onclick="app.showEditTasksMenu()">
                        <div class="modal" onclick="event.stopPropagation()" style="max-width: 500px; width: 90%; padding: 2rem;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                                <h3 style="font-size: 1.25rem; font-weight: bold;">Redigera uppgift</h3>
                                <button onclick="app.showEditTasksMenu()" style="background: none; border: none; font-size: 2rem; cursor: pointer; color: #6b7280; line-height: 1; padding: 0; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; border-radius: 50%; transition: all 0.2s;" onmouseover="this.style.background='#f3f4f6'" onmouseout="this.style.background='none'">√ó</button>
                            </div>
                            
                            <div style="margin-bottom: 1rem;">
                                <label style="display: block; font-weight: 500; margin-bottom: 0.5rem; font-size: 0.9rem;">Namn:</label>
                                <input type="text" id="editTaskName" value="${task.name}" style="width: 100%; padding: 0.6rem; border: 2px solid #e5e7eb; border-radius: 0.5rem; font-size: 0.9rem;">
                            </div>

                            <div style="margin-bottom: 1rem;">
                                <label style="display: block; font-weight: 500; margin-bottom: 0.5rem; font-size: 0.9rem;">Beskrivning (valfritt):</label>
                                <textarea id="editTaskDescription" placeholder="T.ex. instruktioner hur uppgiften ska g√∂ras..." style="width: 100%; padding: 0.6rem; border: 2px solid #e5e7eb; border-radius: 0.5rem; font-size: 0.9rem; min-height: 80px; font-family: inherit;">${task.description || ''}</textarea>
                            </div>

                            <div style="margin-bottom: 1rem;">
                                <label style="display: block; font-weight: 500; margin-bottom: 0.5rem; font-size: 0.9rem;">Po√§ng:</label>
                                <input type="number" id="editTaskPoints" value="${task.points}" min="1" max="100" style="width: 100%; padding: 0.6rem; border: 2px solid #e5e7eb; border-radius: 0.5rem; font-size: 0.9rem;">
                            </div>

                            <div style="margin-bottom: 1.5rem;">
                                <label style="display: block; font-weight: 500; margin-bottom: 0.5rem; font-size: 0.9rem;">Frekvens:</label>
                                <select id="editTaskFrequency" style="width: 100%; padding: 0.6rem; border: 2px solid #e5e7eb; border-radius: 0.5rem; font-size: 0.9rem;">
                                    <option value="daily" ${task.frequency === 'daily' ? 'selected' : ''}>Daglig</option>
                                    <option value="weekly" ${task.frequency === 'weekly' ? 'selected' : ''}>Veckovis</option>
                                </select>
                            </div>

                            <button class="btn btn-primary" style="width: 100%; padding: 0.8rem; font-size: 0.95rem;" onclick="app.saveEditedTask(${roomId}, ${taskId})">
                                Spara √§ndringar
                            </button>
                        </div>
                    </div>
                `;
            },

            saveEditedTask(roomId, taskId) {
                const name = document.getElementById('editTaskName').value.trim();
                const description = document.getElementById('editTaskDescription').value.trim();
                const points = parseInt(document.getElementById('editTaskPoints').value);
                const frequency = document.getElementById('editTaskFrequency').value;

                if (!name) {
                    alert('Namnet f√•r inte vara tomt!');
                    return;
                }

                if (points < 1 || points > 100) {
                    alert('Po√§ng m√•ste vara mellan 1 och 100!');
                    return;
                }

                this.rooms = this.rooms.map(room => {
                    if (room.id === roomId) {
                        return {
                            ...room,
                            tasks: room.tasks.map(task => {
                                if (task.id === taskId) {
                                    return { ...task, name, points, frequency, description };
                                }
                                return task;
                            })
                        };
                    }
                    return room;
                });

                this.saveData();
                alert('Uppgift uppdaterad!');
                this.showEditTasksMenu();
            },

            deleteTask(roomId, taskId) {
                const room = this.rooms.find(r => r.id === roomId);
                const task = room.tasks.find(t => t.id === taskId);
                
                if (!confirm(`Vill du verkligen ta bort "${task.name}"?`)) return;

                this.rooms = this.rooms.map(r => {
                    if (r.id === roomId) {
                        return {
                            ...r,
                            tasks: r.tasks.filter(t => t.id !== taskId)
                        };
                    }
                    return r;
                });

                this.saveData();
                alert('Uppgift borttagen!');
                this.showEditTasksMenu();
            },

            showAddTaskMenu() {
                const modal = document.getElementById('taskModal');
                modal.innerHTML = `
                    <div class="modal-overlay" onclick="app.closeAdminPanel()">
                        <div class="modal" onclick="event.stopPropagation()" style="max-width: 500px; width: 90%; padding: 2rem;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                                <h3 style="font-size: 1.25rem; font-weight: bold;">‚ûï L√§gg till</h3>
                                <button onclick="app.showAdminPanel()" style="background: none; border: none; font-size: 2rem; cursor: pointer; color: #6b7280; line-height: 1; padding: 0; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; border-radius: 50%; transition: all 0.2s;" onmouseover="this.style.background='#f3f4f6'" onmouseout="this.style.background='none'">√ó</button>
                            </div>
                            
                            <div style="margin-bottom: 1rem;">
                                <label style="display: block; font-weight: 500; margin-bottom: 0.5rem; font-size: 0.9rem;">Rum:</label>
                                <select id="addTaskRoom" style="width: 100%; padding: 0.6rem; border: 2px solid #e5e7eb; border-radius: 0.5rem; font-size: 0.9rem;">
                                    ${this.rooms.map(room => `
                                        <option value="${room.id}">${room.icon} ${room.name}</option>
                                    `).join('')}
                                </select>
                            </div>

                            <div style="margin-bottom: 1rem;">
                                <label style="display: block; font-weight: 500; margin-bottom: 0.5rem; font-size: 0.9rem;">Namn:</label>
                                <input type="text" id="addTaskName" placeholder="T.ex. Damma hyllor" style="width: 100%; padding: 0.6rem; border: 2px solid #e5e7eb; border-radius: 0.5rem; font-size: 0.9rem;">
                            </div>

                            <div style="margin-bottom: 1rem;">
                                <label style="display: block; font-weight: 500; margin-bottom: 0.5rem; font-size: 0.9rem;">Beskrivning (valfritt):</label>
                                <textarea id="addTaskDescription" placeholder="T.ex. instruktioner hur uppgiften ska g√∂ras..." style="width: 100%; padding: 0.6rem; border: 2px solid #e5e7eb; border-radius: 0.5rem; font-size: 0.9rem; min-height: 80px; font-family: inherit;"></textarea>
                            </div>

                            <div style="margin-bottom: 1rem;">
                                <label style="display: block; font-weight: 500; margin-bottom: 0.5rem; font-size: 0.9rem;">Po√§ng:</label>
                                <input type="number" id="addTaskPoints" value="10" min="1" max="100" style="width: 100%; padding: 0.6rem; border: 2px solid #e5e7eb; border-radius: 0.5rem; font-size: 0.9rem;">
                            </div>

                            <div style="margin-bottom: 1.5rem;">
                                <label style="display: block; font-weight: 500; margin-bottom: 0.5rem; font-size: 0.9rem;">Frekvens:</label>
                                <select id="addTaskFrequency" style="width: 100%; padding: 0.6rem; border: 2px solid #e5e7eb; border-radius: 0.5rem; font-size: 0.9rem;">
                                    <option value="daily">Daglig</option>
                                    <option value="weekly" selected>Veckovis</option>
                                </select>
                            </div>

                            <button class="btn btn-primary" style="width: 100%; padding: 0.8rem; font-size: 0.95rem;" onclick="app.saveNewTask()">
                                L√§gg till uppgift
                            </button>
                        </div>
                    </div>
                `;
            },

            saveNewTask() {
                const roomId = parseInt(document.getElementById('addTaskRoom').value);
                const name = document.getElementById('addTaskName').value.trim();
                const description = document.getElementById('addTaskDescription').value.trim();
                const points = parseInt(document.getElementById('addTaskPoints').value);
                const frequency = document.getElementById('addTaskFrequency').value;

                if (!name) {
                    alert('Namnet f√•r inte vara tomt!');
                    return;
                }

                if (points < 1 || points > 100) {
                    alert('Po√§ng m√•ste vara mellan 1 och 100!');
                    return;
                }

                // Hitta h√∂gsta task ID
                let maxId = 0;
                this.rooms.forEach(room => {
                    room.tasks.forEach(task => {
                        if (task.id > maxId) maxId = task.id;
                    });
                });

                const newTask = {
                    id: maxId + 1,
                    name,
                    description,
                    points,
                    frequency,
                    completed: false,
                    completedBy: null,
                    bookedBy: null,
                    bookedUntil: null
                };

                this.rooms = this.rooms.map(room => {
                    if (room.id === roomId) {
                        return {
                            ...room,
                            tasks: [...room.tasks, newTask]
                        };
                    }
                    return room;
                });

                this.saveData();
                alert(`Uppgift "${name}" tillagd!`);
                this.closeAdminPanel();
                this.render();
            },

            render() {
                document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
                const activeNav = document.getElementById(`nav-${this.currentView}`);
                if (activeNav) activeNav.classList.add('active');

                const content = document.getElementById('content');
                
                if (this.currentView === 'overview') {
                    content.innerHTML = this.renderOverview();
                } else if (this.currentView === 'bedroom-select') {
                    content.innerHTML = this.renderBedroomSelect();
                } else if (this.currentView === 'room' && this.selectedRoom) {
                    content.innerHTML = this.renderRoom();
                } else if (this.currentView === 'stats') {
                    content.innerHTML = this.renderStats();
                } else if (this.currentView === 'completed') {
                    content.innerHTML = this.renderCompleted();
                } else if (this.currentView === 'achievements') {
                    content.innerHTML = this.renderAchievements();
                } else if (this.currentView === 'family') {
                    content.innerHTML = this.renderFamily();
                }
            },

            renderOverview() {
                const myBookedTasks = [];
                this.rooms.forEach(room => {
                    room.tasks.forEach(task => {
                        if (task.bookedBy === this.currentUser.id && task.bookedUntil && Date.now() < task.bookedUntil) {
                            myBookedTasks.push({ ...task, room: room.name, roomId: room.id, roomColor: room.color });
                        }
                    });
                });

                const dailyTasks = this.getDailyTasks();

                return `
                    <div class="gradient-box">
                        <div class="gradient-box-header">
                            <div>
                                <h2 style="font-size: 1.5rem; font-weight: bold;">Hej ${this.currentUser.name}! üëã</h2>
                                <p style="opacity: 0.9; margin-top: 0.25rem;">Dags att tj√§na lite pengar!</p>
                                <div style="display: inline-block; background: rgba(255,255,255,0.3); padding: 0.25rem 0.75rem; border-radius: 1rem; margin-top: 0.5rem; font-size: 0.9rem; font-weight: 600;">
                                    Level ${this.getUserLevel(this.currentUser)} ¬∑ ${this.getUserTitle(this.currentUser)}
                                </div>
                            </div>
                            <div style="text-align: right;">
                                <div style="display: flex; align-items: center; gap: 0.75rem; justify-content: flex-end;">
                                    <button onclick="app.setView('achievements')" style="background: rgba(255,255,255,0.2); border: 2px solid rgba(255,255,255,0.3); color: white; padding: 0.5rem 0.75rem; border-radius: 0.5rem; cursor: pointer; font-size: 1.25rem; transition: all 0.2s;" onmouseover="this.style.background='rgba(255,255,255,0.3)'" onmouseout="this.style.background='rgba(255,255,255,0.2)'">
                                        üèÜ
                                    </button>
                                    <div>
                                        <div style="font-size: 1.875rem; font-weight: bold;">${this.currentUser.money.toFixed(0)} kr</div>
                                        <div style="font-size: 0.875rem; opacity: 0.9;">${this.currentUser.points} po√§ng</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div style="margin-top: 1rem; background: rgba(255,255,255,0.2); border-radius: 0.5rem; padding: 0.5rem;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 0.25rem; font-size: 0.85rem;">
                                <span>Progress till Level ${this.getUserLevel(this.currentUser) + 1}</span>
                                <span>${this.currentUser.points % this.pointsPerLevel}/${this.pointsPerLevel}p</span>
                            </div>
                            <div style="background: rgba(255,255,255,0.3); border-radius: 0.25rem; height: 8px; overflow: hidden;">
                                <div style="background: white; height: 100%; width: ${this.getProgressToNextLevel(this.currentUser)}%; transition: width 0.3s;"></div>
                            </div>
                        </div>
                    </div>

                    <div class="stats-grid">
                        <div class="stat-box blue task-clickable" onclick="app.showCompletedModal()">
                            <div class="stat-icon">‚úÖ</div>
                            <div class="stat-value blue">${this.getCompletedTasks()}</div>
                            <div class="stat-label">Klara</div>
                        </div>
                        <div class="stat-box orange task-clickable" onclick="app.showRemainingModal()">
                            <div class="stat-icon">üìã</div>
                            <div class="stat-value orange">${this.getTotalTasks() - this.getCompletedTasks()}</div>
                            <div class="stat-label">Kvar</div>
                        </div>
                        <div class="stat-box teal task-clickable" onclick="app.showBookedModal()">
                            <div class="stat-icon">‚è±Ô∏è</div>
                            <div class="stat-value teal">${this.getTotalBookedTasks()}</div>
                            <div class="stat-label">Paxade</div>
                        </div>
                    </div>

                    ${myBookedTasks.length > 0 ? `
                        <div class="section">
                            <h3 class="section-title">Mina paxade uppgifter</h3>
                            ${myBookedTasks.map(task => `
                                <div class="task-card" style="background: #ccfbf1; border-color: #5eead4;">
                                    <div class="task-info">
                                        <div>
                                            <div class="task-name">${task.name}</div>
                                            <div class="task-room">${task.room}</div>
                                        </div>
                                    </div>
                                    <div style="display: flex; gap: 0.75rem; align-items: center;">
                                        <span class="badge" style="background: #99f6e4; color: #134e4a;">
                                            ‚è±Ô∏è ${this.getTimeRemaining(task.bookedUntil)}
                                        </span>
                                        <button class="btn btn-primary" onclick="event.stopPropagation(); app.completeTask(${task.roomId}, ${task.id})" style="padding: 0.4rem 0.8rem; font-size: 0.85rem;">
                                            ‚úÖ Klar
                                        </button>
                                        <button class="btn btn-secondary" onclick="app.selectRoom(app.rooms.find(r => r.id === ${task.roomId}))" style="padding: 0.4rem 0.8rem; font-size: 0.85rem;">
                                            G√∂r nu
                                        </button>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    ` : ''}

                    <div class="section">
                        <h3 class="section-title">Dagens uppgifter</h3>
                        ${(() => {
                            const tasksToShow = this.showAllDailyTasks ? dailyTasks : dailyTasks.slice(0, 5);
                            return tasksToShow.map(task => {
                                const isBookedByMe = task.bookedBy === this.currentUser.id;
                                const isBookedByOther = task.bookedBy && task.bookedBy !== this.currentUser.id;
                                const bookedUser = isBookedByOther ? this.users.find(u => u.id === task.bookedBy) : null;
                                
                                return `
                                    <div class="task-card task-clickable" onclick="app.showTaskModal(${task.id})" style="background-color: ${task.completed ? '#f0fdf4' : task.roomColor + '33'}; border-color: ${task.completed ? '#86efac' : task.roomColor};">
                                        <div class="task-info">
                                            ${task.completed ? '<svg class="check-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>' : ''}
                                            <div>
                                                <div class="task-name">
                                                    ${task.name}
                                                    ${(isBookedByMe || isBookedByOther) ? `<span class="badge-white">${isBookedByMe ? '‚è±Ô∏è Paxad' : 'üîí ' + bookedUser.name}</span>` : ''}
                                                </div>
                                                <div class="task-room">${task.room}</div>
                                            </div>
                                        </div>
                                        <span class="badge" style="background: ${task.roomColor}; color: white;">
                                            ${task.points}p
                                        </span>
                                    </div>
                                `;
                            }).join('');
                        })()}
                        ${dailyTasks.length > 5 ? `
                            <button onclick="app.toggleDailyTasks()" class="btn" style="width: 100%; margin-top: 0.75rem; background: #f3f4f6; color: #374151; display: flex; align-items: center; justify-content: center; gap: 0.5rem;">
                                <span>${this.showAllDailyTasks ? 'Visa f√§rre' : `Visa alla (${dailyTasks.length - 5} till)`}</span>
                                <svg style="width: 1.25rem; height: 1.25rem; transform: ${this.showAllDailyTasks ? 'rotate(180deg)' : 'rotate(0deg)'}; transition: transform 0.2s;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                                </svg>
                            </button>
                        ` : ''}
                    </div>

                    <div class="section">
                        <h3 class="section-title">Rum</h3>
                        <div class="room-grid">
                            ${(() => {
                                const nonBedroomRooms = this.rooms.filter(r => !r.name.startsWith('Sovrum'));
                                const roomsToShow = this.showAllRooms ? nonBedroomRooms : nonBedroomRooms.slice(0, 5);
                                
                                return roomsToShow.map(room => {
                                    const completed = room.tasks.filter(t => t.completed).length;
                                    const total = room.tasks.length;
                                    return `
                                        <button class="room-button" onclick="app.selectRoom(app.rooms.find(r => r.id === ${room.id}))" style="border-color: ${room.color};">
                                            <div style="position: absolute; top: 0; left: 0; right: 0; height: 4px; background: ${room.color};"></div>
                                            <div class="room-icon">${room.icon}</div>
                                            <div class="room-name">${room.name}</div>
                                            <div class="room-progress">${completed}/${total} klara</div>
                                        </button>
                                    `;
                                }).join('');
                            })()}
                            ${(() => {
                                const bedrooms = this.rooms.filter(r => r.name.startsWith('Sovrum'));
                                const totalCompleted = bedrooms.reduce((sum, room) => sum + room.tasks.filter(t => t.completed).length, 0);
                                const totalTasks = bedrooms.reduce((sum, room) => sum + room.tasks.length, 0);
                                return `
                                    <button class="room-button" onclick="app.selectRoom({name: 'Sovrum'})" style="border-color: #ec4899;">
                                        <div style="position: absolute; top: 0; left: 0; right: 0; height: 4px; background: #ec4899;"></div>
                                        <div class="room-icon">üõèÔ∏è</div>
                                        <div class="room-name">Sovrum</div>
                                        <div class="room-progress">${totalCompleted}/${totalTasks} klara</div>
                                    </button>
                                `;
                            })()}
                        </div>
                        ${(() => {
                            const nonBedroomRooms = this.rooms.filter(r => !r.name.startsWith('Sovrum'));
                            if (nonBedroomRooms.length > 5) {
                                return `
                                    <button onclick="app.toggleRooms()" class="btn" style="width: 100%; margin-top: 0.75rem; background: #f3f4f6; color: #374151; display: flex; align-items: center; justify-content: center; gap: 0.5rem;">
                                        <span>${this.showAllRooms ? 'Visa f√§rre rum' : `Visa fler rum (${nonBedroomRooms.length - 5} till)`}</span>
                                        <svg style="width: 1.25rem; height: 1.25rem; transform: ${this.showAllRooms ? 'rotate(180deg)' : 'rotate(0deg)'}; transition: transform 0.2s;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                                        </svg>
                                    </button>
                                `;
                            }
                            return '';
                        })()}
                    </div>
                `;
            },

            renderRoom() {
                return `
                    <div style="display: flex; justify-content: flex-end; margin-bottom: 1rem;">
                        <button onclick="app.setView('overview')" style="background: none; border: none; font-size: 2rem; cursor: pointer; color: #6b7280; line-height: 1; padding: 0; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; border-radius: 50%; transition: all 0.2s;" onmouseover="this.style.background='#f3f4f6'" onmouseout="this.style.background='none'">√ó</button>
                    </div>
                    
                    <div class="gradient-box">
                        <div style="font-size: 3rem; margin-bottom: 0.75rem;">${this.selectedRoom.icon}</div>
                        <h2 style="font-size: 1.5rem; font-weight: bold;">${this.selectedRoom.name}</h2>
                    </div>

                    <div class="info-box">
                        <div class="info-text">Du har bokat ${this.getBookedTasksCount(this.currentUser.id)}/3 uppgifter</div>
                    </div>

                    <button class="btn btn-secondary" style="width: 100%; margin-bottom: 1rem; padding: 0.75rem; font-size: 1rem;" onclick="app.bookWholeRoom(${this.selectedRoom.id})">
                        ‚è±Ô∏è Paxa hela rummet
                    </button>

                    ${this.selectedRoom.tasks.map(task => {
                        const isBookedByMe = task.bookedBy === this.currentUser.id && task.bookedUntil && Date.now() < task.bookedUntil;
                        const isBookedByOther = task.bookedBy && task.bookedBy !== this.currentUser.id && task.bookedUntil && Date.now() < task.bookedUntil;
                        const bookedUser = isBookedByOther ? this.users.find(u => u.id === task.bookedBy) : null;

                        return `
                            <div class="task-detail task-clickable" onclick="app.showTaskModal(${task.id})" style="
                                background: ${task.completed ? '#f0fdf4' : this.selectedRoom.color + '33'};
                                border-color: ${task.completed ? '#86efac' : this.selectedRoom.color};
                            ">
                                <div style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
                                    <div style="flex: 1;">
                                        <div class="task-header">
                                            <div class="task-title">${task.name}</div>
                                            ${task.frequency === 'daily' ? '<span class="badge" style="background: #dbeafe; color: #1e40af; font-size: 0.75rem;">Daglig</span>' : ''}
                                        </div>
                                        
                                        <div class="task-meta">
                                            <span class="badge" style="background: ${this.selectedRoom.color}; color: white;">
                                                ${task.points} po√§ng
                                            </span>
                                            ${task.completed && task.completedBy ? `<span style="color: #10b981;">‚úì ${this.users.find(u => u.id === task.completedBy)?.name}</span>` : ''}
                                        </div>

                                        ${isBookedByMe && !task.completed ? `
                                            <div class="booking-status" style="color: #0f766e;">
                                                <span>‚è±Ô∏è Bokad av dig</span>
                                                <span class="booking-badge" style="background: #99f6e4;">
                                                    ${this.getTimeRemaining(task.bookedUntil)}
                                                </span>
                                            </div>
                                        ` : ''}
                                        ${isBookedByOther && !task.completed ? `
                                            <div class="booking-status" style="color: #c2410c;">
                                                <span>üîí Bokad av ${bookedUser?.name}</span>
                                                <span class="booking-badge" style="background: #fed7aa;">
                                                    ${this.getTimeRemaining(task.bookedUntil)}
                                                </span>
                                            </div>
                                        ` : ''}
                                    </div>

                                    <div style="margin-left: 1rem;">
                                        ${task.completed ? `
                                            <svg class="check-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                                            </svg>
                                        ` : isBookedByOther ? `
                                            <svg style="width: 2rem; height: 2rem; color: #fb923c;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/>
                                            </svg>
                                        ` : `
                                            <svg style="width: 2rem; height: 2rem; color: ${this.selectedRoom.color};" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                                            </svg>
                                        `}
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('')}
                `;
            },

            renderStats() {
                const maxPoints = Math.max(...this.users.map(u => u.points || 1));
                const leaderboard = this.getWeeklyLeaderboard();
                
                return `
                    <h2 class="section-title" style="font-size: 1.5rem;">Statistik üìä</h2>
                    
                    <!-- Veckolig t√§vling -->
                    <div style="background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%); border-radius: 0.75rem; padding: 1.5rem; margin-bottom: 1.5rem; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                        <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.5rem;">
                            <div style="font-size: 2rem;">üèÜ</div>
                            <div>
                                <h3 style="font-size: 1.25rem; font-weight: bold; color: white;">Veckans t√§vling</h3>
                                <div style="font-size: 0.875rem; color: rgba(255,255,255,0.9);">Vem tj√§nar mest denna vecka?</div>
                            </div>
                        </div>
                        <div style="background: rgba(255,255,255,0.2); border-radius: 0.5rem; padding: 0.75rem; margin-bottom: 1rem;">
                            <div style="text-align: center; color: white;">
                                <div style="font-size: 0.875rem; font-weight: 600; margin-bottom: 0.25rem;">üéÅ PRIS</div>
                                <div style="font-size: 1.5rem; font-weight: bold;">25 po√§ng till vinnaren!</div>
                                <div style="font-size: 0.75rem; opacity: 0.9; margin-top: 0.25rem;">T√§vlingen avslutas p√• s√∂ndag kv√§ll</div>
                            </div>
                        </div>
                        
                        ${leaderboard.map((user, index) => {
                            const medals = ['ü•á', 'ü•à', 'ü•â'];
                            const medal = medals[index] || `${index + 1}.`;
                            return `
                                <div style="
                                    background: ${index === 0 ? 'rgba(255,255,255,0.95)' : 'rgba(255,255,255,0.8)'};
                                    border-radius: 0.5rem;
                                    padding: 0.75rem;
                                    margin-bottom: 0.5rem;
                                    display: flex;
                                    align-items: center;
                                    gap: 0.75rem;
                                    ${index === 0 ? 'box-shadow: 0 2px 8px rgba(251,191,36,0.4); border: 2px solid #fbbf24;' : ''}
                                ">
                                    <div style="font-size: 1.5rem; min-width: 2rem; text-align: center;">${medal}</div>
                                    <div class="user-avatar" style="
                                        width: 2.5rem;
                                        height: 2.5rem;
                                        font-size: 1.25rem;
                                        background: ${user.color}33;
                                        border-color: ${user.color};
                                    ">
                                        ${user.avatar}
                                    </div>
                                    <div style="flex: 1;">
                                        <div style="font-weight: 600; color: #1f2937;">${user.name}</div>
                                        <div style="font-size: 0.875rem; color: #6b7280;">${user.weekPoints}p denna vecka</div>
                                    </div>
                                    ${index === 0 ? '<div style="font-size: 1.5rem;">üëë</div>' : ''}
                                </div>
                            `;
                        }).join('')}
                    </div>
                    
                    ${this.users.map(user => `
                        <div class="user-card">
                            <div class="user-header">
                                <div class="user-info">
                                    <div class="user-avatar" style="background: ${user.color}33; border-color: ${user.color};">
                                        ${user.avatar}
                                    </div>
                                    <div>
                                        <div class="user-name">${user.name}</div>
                                        <div style="font-size: 0.85rem; color: ${user.color}; font-weight: 600; margin-top: 0.25rem;">
                                            Level ${this.getUserLevel(user)} ¬∑ ${this.getUserTitle(user)}
                                        </div>
                                        <div class="user-stats">${user.points} po√§ng</div>
                                    </div>
                                </div>
                                <div style="text-align: right;">
                                    <div style="font-size: 1.5rem; font-weight: bold; color: ${user.color};">
                                        ${user.money.toFixed(0)} kr
                                    </div>
                                </div>
                            </div>
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: ${(user.points / maxPoints) * 100}%; background: ${user.color};"></div>
                            </div>
                        </div>
                    `).join('')}

                    <div style="background: #dbeafe; border-radius: 0.75rem; padding: 1rem; margin-top: 1.5rem;">
                        <h3 style="font-weight: bold; margin-bottom: 0.5rem;">Totalt tj√§nat denna vecka</h3>
                        <div style="font-size: 1.875rem; font-weight: bold; color: #2563eb;">
                            ${this.users.reduce((sum, user) => sum + user.money, 0).toFixed(0)} kr
                        </div>
                    </div>
                `;
            },

            renderAchievements() {
                return `
                    <h2 class="section-title" style="font-size: 1.5rem;">Achievements üèÜ</h2>
                    
                    ${this.achievements.map(achievement => {
                        const unlocked = this.currentUser.achievements && this.currentUser.achievements.includes(achievement.id);
                        return `
                            <div class="achievement-card" style="
                                background: ${unlocked ? 'linear-gradient(to right, #d1fae5, #a7f3d0)' : '#f9fafb'};
                                border-color: ${unlocked ? '#10b981' : '#e5e7eb'};
                                opacity: ${unlocked ? '1' : '0.6'};
                            ">
                                <div class="achievement-icon">${achievement.icon}</div>
                                <div class="achievement-info">
                                    <div class="achievement-name">${achievement.name}</div>
                                    <div class="achievement-desc">${achievement.description}</div>
                                    <div class="achievement-points">+${achievement.points} po√§ng</div>
                                </div>
                                ${unlocked ? '<svg class="check-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>' : ''}
                            </div>
                        `;
                    }).join('')}
                `;
            },

            renderBedroomSelect() {
                const bedrooms = this.rooms.filter(r => r.name.startsWith('Sovrum'));
                
                return `
                    <div style="display: flex; justify-content: flex-end; margin-bottom: 1rem;">
                        <button onclick="app.setView('overview')" style="background: none; border: none; font-size: 2rem; cursor: pointer; color: #6b7280; line-height: 1; padding: 0; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; border-radius: 50%; transition: all 0.2s;" onmouseover="this.style.background='#f3f4f6'" onmouseout="this.style.background='none'">√ó</button>
                    </div>
                    
                    <div class="gradient-box">
                        <div style="text-align: center;">
                            <div style="font-size: 3rem; margin-bottom: 0.75rem;">üõèÔ∏è</div>
                            <h2 style="font-size: 1.5rem; font-weight: bold;">V√§lj sovrum</h2>
                        </div>
                    </div>

                    <div class="room-grid">
                        ${bedrooms.map(room => {
                            const completed = room.tasks.filter(t => t.completed).length;
                            const total = room.tasks.length;
                            // Extrahera namnet fr√•n parentesen
                            const ownerName = room.name.match(/\((.*?)\)/)[1];
                            
                            return `
                                <button class="room-button" onclick="app.selectBedroom(${room.id})" style="border-color: ${room.color};">
                                    <div style="position: absolute; top: 0; left: 0; right: 0; height: 4px; background: ${room.color};"></div>
                                    <div class="room-icon">${room.icon}</div>
                                    <div class="room-name">${ownerName}</div>
                                    <div class="room-progress">${completed}/${total} klara</div>
                                </button>
                            `;
                        }).join('')}
                    </div>
                `;
            },

            renderCompleted() {
                const selectedUserId = window.selectedCompletedUserId || 'all';
                
                const completedTasks = [];
                this.rooms.forEach(room => {
                    room.tasks.forEach(task => {
                        if (task.completed) {
                            if (selectedUserId === 'all' || task.completedBy === parseInt(selectedUserId)) {
                                completedTasks.push({
                                    ...task,
                                    roomName: room.name,
                                    roomIcon: room.icon,
                                    roomColor: room.color
                                });
                            }
                        }
                    });
                });

                // Gruppera per rum
                const byRoom = {};
                this.rooms.forEach(room => {
                    byRoom[room.id] = {
                        room: room,
                        tasks: completedTasks.filter(t => {
                            // Hitta task i room.tasks f√∂r att matcha
                            return room.tasks.some(rt => rt.id === t.id);
                        })
                    };
                });

                const totalCompleted = completedTasks.length;
                const totalTasks = selectedUserId === 'all' ? this.getTotalTasks() : this.getTotalTasks();
                const selectedUser = selectedUserId !== 'all' ? this.users.find(u => u.id === parseInt(selectedUserId)) : null;

                return `
                    <div class="gradient-box" style="background: linear-gradient(to right, #10b981, #059669);">
                        <div style="text-align: center;">
                            <h2 style="font-size: 1.5rem; font-weight: bold; margin-bottom: 0.5rem;">
                                Slutf√∂rda uppgifter ‚úÖ
                            </h2>
                            <div style="font-size: 2.5rem; font-weight: bold;">${totalCompleted}${selectedUserId === 'all' ? ` / ${totalTasks}` : ''}</div>
                            <div style="opacity: 0.9; margin-top: 0.25rem;">
                                ${selectedUserId === 'all' 
                                    ? `${Math.round((totalCompleted / totalTasks) * 100)}% klart` 
                                    : `${selectedUser ? selectedUser.avatar + ' ' + selectedUser.name : ''}`
                                }
                            </div>
                        </div>
                    </div>
                    
                    <div style="margin-top: 1rem; margin-bottom: 1rem;">
                        <label style="display: block; font-weight: 500; margin-bottom: 0.5rem; font-size: 0.9rem;">Visa uppgifter f√∂r:</label>
                        <select onchange="window.selectedCompletedUserId = this.value; app.render();" style="width: 100%; padding: 0.6rem; border: 2px solid #e5e7eb; border-radius: 0.5rem; font-size: 0.9rem;">
                            <option value="all" ${selectedUserId === 'all' ? 'selected' : ''}>üè† Alla</option>
                            ${this.users.map(user => `
                                <option value="${user.id}" ${selectedUserId === user.id.toString() ? 'selected' : ''}>
                                    ${user.avatar} ${user.name}
                                </option>
                            `).join('')}
                        </select>
                    </div>

                    ${completedTasks.length === 0 ? `
                        <div style="text-align: center; padding: 3rem 1rem; color: #6b7280;">
                            <div style="font-size: 4rem; margin-bottom: 1rem;">üéØ</div>
                            <div style="font-size: 1.125rem; font-weight: 500;">Inga slutf√∂rda uppgifter √§nnu</div>
                            <div style="font-size: 0.875rem; margin-top: 0.5rem;">B√∂rja st√§da f√∂r att tj√§na po√§ng!</div>
                        </div>
                    ` : `
                        ${Object.values(byRoom).filter(group => group.tasks.length > 0).map(group => `
                            <div class="section">
                                <h3 class="section-title" style="display: flex; align-items: center; gap: 0.5rem;">
                                    <span style="font-size: 1.5rem;">${group.room.icon}</span>
                                    <span>${group.room.name}</span>
                                    <span style="font-size: 0.875rem; color: #6b7280; font-weight: normal;">(${group.tasks.length})</span>
                                </h3>
                                
                                ${group.tasks.map(task => {
                                    const completedBy = this.users.find(u => u.id === task.completedBy);
                                    return `
                                        <div class="task-card" style="background: #f0fdf4; border-color: #86efac;">
                                            <div class="task-info">
                                                <svg class="check-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width: 1.5rem; height: 1.5rem;">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                                                </svg>
                                                <div>
                                                    <div class="task-name">${task.name}</div>
                                                    <div class="task-room">
                                                        ${completedBy ? completedBy.name : 'Ok√§nd'}${task.completedAt ? ` ¬∑ ${this.formatDateTime(task.completedAt)}` : ''}
                                                    </div>
                                                </div>
                                            </div>
                                            <div style="display: flex; align-items: center; gap: 0.75rem;">
                                                <div class="user-avatar" style="
                                                    width: 2rem; 
                                                    height: 2rem; 
                                                    font-size: 1rem;
                                                    background: ${completedBy ? completedBy.color + '33' : '#e5e7eb'}; 
                                                    border-color: ${completedBy ? completedBy.color : '#9ca3af'};
                                                ">
                                                    ${completedBy ? completedBy.avatar : '?'}
                                                </div>
                                                <span class="badge" style="background: ${group.room.color}; color: white;">
                                                    +${task.points}p
                                                </span>
                                                ${this.currentUser.isAdmin ? `
                                                    <button class="btn" style="background: #fee2e2; color: #dc2626; border-color: #fca5a5; padding: 0.4rem 0.6rem; font-size: 0.8rem;" onclick="event.stopPropagation(); app.undoCompletedTask(${group.room.id}, ${task.id})">
                                                        ‚Ü©Ô∏è √Öngra
                                                    </button>
                                                ` : ''}
                                            </div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        `).join('')}
                    `}
                `;
            },

            renderFamily() {
                return `
                    <h2 class="section-title" style="font-size: 1.5rem;">Familjen üë®‚Äçüë©‚Äçüëß‚Äçüë¶</h2>
                    
                    ${this.users.map(user => `
                        <div class="user-card" style="background: white; border: 2px solid ${user.color}33; border-radius: 0.75rem; padding: 1rem; margin-bottom: 1rem;">
                            <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem;">
                                <div class="user-avatar" onclick="app.editUserProfile(${user.id})" style="background: ${user.color}33; border-color: ${user.color}; width: 4rem; height: 4rem; font-size: 2rem; cursor: pointer; transition: transform 0.2s;" onmouseover="this.style.transform='scale(1.1)'" onmouseout="this.style.transform='scale(1)'">
                                    ${user.avatar}
                                </div>
                                <div style="flex: 1;">
                                    <div class="user-name" style="font-size: 1.125rem; font-weight: bold;">${user.name}</div>
                                    <div style="font-size: 0.85rem; color: ${user.color}; font-weight: 600;">
                                        Level ${this.getUserLevel(user)} ¬∑ ${this.getUserTitle(user)}
                                    </div>
                                    <div class="user-stats">${user.points} po√§ng</div>
                                </div>
                            </div>

                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; margin-bottom: 1rem;">
                                <div style="background: #f0fdf4; border: 2px solid #86efac; border-radius: 0.5rem; padding: 0.75rem; text-align: center;">
                                    <div style="font-size: 0.75rem; color: #6b7280; margin-bottom: 0.25rem;">Att betala ut</div>
                                    <div style="font-size: 1.25rem; font-weight: bold; color: #10b981;">${user.money.toFixed(2)} kr</div>
                                </div>
                                <div style="background: #f9fafb; border: 2px solid #e5e7eb; border-radius: 0.5rem; padding: 0.75rem; text-align: center;">
                                    <div style="font-size: 0.75rem; color: #6b7280; margin-bottom: 0.25rem;">Utbetalt totalt</div>
                                    <div style="font-size: 1.25rem; font-weight: bold; color: #6b7280;">${(user.totalPaidOut || 0).toFixed(2)} kr</div>
                                </div>
                            </div>

                            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 0.5rem; margin-bottom: 1rem;">
                                <div style="background: #dbeafe; border-radius: 0.5rem; padding: 0.5rem; text-align: center;">
                                    <div style="font-size: 0.7rem; color: #6b7280;">Denna vecka</div>
                                    <div style="font-size: 0.9rem; font-weight: 600; color: #1e40af;">${this.getEarningsForPeriod(user, 'week').toFixed(0)} kr</div>
                                </div>
                                <div style="background: #fef3c7; border-radius: 0.5rem; padding: 0.5rem; text-align: center;">
                                    <div style="font-size: 0.7rem; color: #6b7280;">Denna m√•nad</div>
                                    <div style="font-size: 0.9rem; font-weight: 600; color: #92400e;">${this.getEarningsForPeriod(user, 'month').toFixed(0)} kr</div>
                                </div>
                                <div style="background: #e0e7ff; border-radius: 0.5rem; padding: 0.5rem; text-align: center;">
                                    <div style="font-size: 0.7rem; color: #6b7280;">Detta √•r</div>
                                    <div style="font-size: 0.9rem; font-weight: 600; color: #4338ca;">${this.getEarningsForPeriod(user, 'year').toFixed(0)} kr</div>
                                </div>
                            </div>

                            ${this.currentUser.isAdmin ? `
                                <button class="btn btn-primary" style="width: 100%; padding: 0.75rem; background: ${user.money > 0 ? '#10b981' : '#9ca3af'}; border-color: ${user.money > 0 ? '#059669' : '#6b7280'};" onclick="app.payoutUser(${user.id})" ${user.money <= 0 ? 'disabled' : ''}>
                                    üí∞ Betala ut ${user.money.toFixed(2)} kr
                                </button>
                            ` : ''}
                        </div>
                    `).join('')}

                    <div class="total-box">
                        <h3 class="total-title">Familjens statistik</h3>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-top: 1rem;">
                            <div style="text-align: center;">
                                <div style="font-size: 0.875rem; color: #6b7280; margin-bottom: 0.5rem;">Att betala ut</div>
                                <div class="total-money" style="color: #10b981;">
                                    ${this.users.reduce((sum, user) => sum + user.money, 0).toFixed(0)} kr
                                </div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 0.875rem; color: #6b7280; margin-bottom: 0.5rem;">Totalt utbetalt</div>
                                <div class="total-money">
                                    ${this.users.reduce((sum, user) => sum + (user.totalPaidOut || 0), 0).toFixed(0)} kr
                                </div>
                            </div>
                        </div>
                        <div style="text-align: center; margin-top: 1rem;">
                            <div style="font-size: 0.875rem; color: #6b7280; margin-bottom: 0.5rem;">Totala po√§ng</div>
                            <div class="total-points">
                                ${this.users.reduce((sum, user) => sum + user.points, 0)} po√§ng
                            </div>
                        </div>
                    </div>
                `;
            }
        };

        window.addEventListener('DOMContentLoaded', () => app.init());
    </script>
</body>
</html>